<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>VOID HUNTER ‚Äî Online Shooter</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { background:#000; overflow:hidden; font-family:"Courier New",monospace; }
canvas { position:fixed; top:0; left:0; z-index:0; }

#overlay {
  position:fixed; inset:0; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  background:linear-gradient(160deg,#050510 0%,#000 100%); z-index:10;
  overflow-y:auto; padding:20px 0 30px;
}
#overlay h1 { font-size:3.2rem; letter-spacing:.3em; color:#0ff;
  text-shadow:0 0 20px #0ff,0 0 60px #0af; animation:pulse 2s infinite; }
#overlay p.sub { color:#888; margin-top:.4rem; font-size:.82rem; letter-spacing:.1em; }

.ctrl-cols { display:flex; gap:36px; justify-content:center; margin-top:.8rem; }
.ctrl-col { display:flex; flex-direction:column; gap:2px; min-width:160px; }
.ctrl-col h4 { color:#0ff; font-size:.62rem; letter-spacing:.2em; margin-bottom:3px;
  border-bottom:1px solid #0af3; padding-bottom:2px; }
.ctrl-row { color:#555; font-size:.63rem; }
.ctrl-row span { color:#0af; }

#name-row { display:flex; flex-direction:column; align-items:center; gap:4px; margin-top:.9rem; }
#name-label { color:#555; font-size:.68rem; letter-spacing:.2em; }
#player-name { background:transparent; border:none; border-bottom:2px solid #0af;
  color:#0ff; font-family:"Courier New",monospace; font-size:1.05rem;
  text-align:center; letter-spacing:.15em; width:190px; outline:none; padding:3px 0; }
#player-name::placeholder { color:#334; }
#name-error { color:#f44; font-size:.62rem; margin-top:3px; height:13px; }
#player-name.shake { animation:shake .3s; border-bottom-color:#f44; }

.btn-row { display:flex; gap:10px; margin-top:.9rem; flex-wrap:wrap; justify-content:center; }
.btn { padding:.62rem 1.8rem; background:transparent; border:2px solid #0ff; color:#0ff;
  font-family:"Courier New",monospace; font-size:.88rem; letter-spacing:.18em;
  cursor:pointer; transition:all .2s; }
.btn:hover { background:#0ff2; box-shadow:0 0 16px #0ff; }
.btn.grn { border-color:#0f8; color:#0f8; }
.btn.grn:hover { background:#0f82; box-shadow:0 0 16px #0f8; }
.btn.org { border-color:#fa0; color:#fa0; }
.btn.org:hover { background:#fa02; }
.btn.sml { font-size:.72rem; padding:.45rem 1rem; border-width:1px; }
.btn.sml.muted { color:#444; border-color:#333; }

/* ‚îÄ‚îÄ NETWORK UI ‚îÄ‚îÄ */
#net-panel {
  margin-top:1rem; width:360px; border:1px solid #0af3;
  padding:14px 18px; display:none; flex-direction:column; align-items:center; gap:8px;
}
#net-panel.show { display:flex; }
#net-panel h3 { color:#0af; font-size:.75rem; letter-spacing:.25em; }
#net-status { color:#888; font-size:.68rem; letter-spacing:.12em; min-height:16px; text-align:center; }
#net-status.ok  { color:#0f8; }
#net-status.err { color:#f44; }
.net-row { display:flex; gap:8px; width:100%; align-items:center; }
#room-code-input { flex:1; background:transparent; border:none; border-bottom:1px solid #0af5;
  color:#0ff; font-family:"Courier New",monospace; font-size:1rem; letter-spacing:.2em;
  text-align:center; text-transform:uppercase; outline:none; padding:3px 0; }
#room-code-input::placeholder { color:#334; font-size:.7rem; }
#room-code-display {
  font-size:2rem; letter-spacing:.35em; color:#0ff;
  text-shadow:0 0 15px #0ff; text-align:center; margin:.2rem 0;
}
#net-waiting { color:#888; font-size:.65rem; letter-spacing:.15em; animation:blink 1.2s infinite; }

/* ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ */
#lb-wrap { margin-top:.9rem; width:340px; }
#lb-wrap h4 { color:#0af; font-size:.62rem; letter-spacing:.25em; text-align:center; margin-bottom:5px; }
#lb-list { list-style:none; }
#lb-list li { display:flex; justify-content:space-between; align-items:center;
  padding:3px 6px; font-size:.68rem; border-bottom:1px solid #0af1; }
#lb-list li .r { width:22px; }
#lb-list li .n { flex:1; color:#0af; }
#lb-list li .s { color:#0ff; }
#lb-list li .w { color:#555; font-size:.58rem; margin-left:5px; }
#lb-list li.g .r,.g .n,.g .s{color:#ffd700;}
#lb-list li.sv .r,.sv .n,.sv .s{color:#c0c0c0;}
#lb-list li.br .r,.br .n,.br .s{color:#cd7f32;}

/* ‚îÄ‚îÄ HUD ‚îÄ‚îÄ */
#hud { position:fixed; inset:0; pointer-events:none; z-index:5; display:none; }
#xhair-p1,#xhair-p2 { position:absolute; width:22px; height:22px; }
#xhair-p1::before,#xhair-p1::after,
#xhair-p2::before,#xhair-p2::after {
  content:""; position:absolute; background:rgba(255,255,255,.85);
}
#xhair-p1::before,#xhair-p2::before { width:2px; height:22px; left:10px; top:0; }
#xhair-p1::after, #xhair-p2::after  { width:22px; height:2px; left:0; top:10px; }
#xhair-p1.dual::before { box-shadow:7px 0 rgba(255,255,255,.85),-7px 0 rgba(255,255,255,.85); }
/* Single: center */
#xhair-p1 { top:50%; left:50%; transform:translate(-50%,-50%); }
#xhair-p2 { display:none; }

.phud { position:absolute; display:flex; flex-direction:column; gap:3px; }
#p1hud { bottom:22px; left:22px; }
#p2hud { bottom:22px; right:22px; text-align:right; display:none; }
.plbl { font-size:.58rem; color:#aaa; letter-spacing:.12em; }
.hptrack { width:150px; height:6px; background:#111; border:1px solid #0af3; }
.hpfill  { height:100%; background:linear-gradient(90deg,#f44,#fa0,#0f8); width:100%; transition:width .2s; }
.ammobig { font-size:1.4rem; color:#0af; }
.weplbl  { font-size:.58rem; color:#0ff; letter-spacing:.15em; }
.rbar    { height:3px; background:#0ff; width:0; transition:width 0s; margin-top:2px; }

#score   { position:absolute; top:14px; right:22px; color:#fff; font-size:.82rem; letter-spacing:.2em; }
#waveinfo{ position:absolute; top:14px; left:22px; color:#ffd700; font-size:.72rem; letter-spacing:.15em; }
#maplbl  { position:absolute; top:33px; left:22px; color:#888; font-size:.58rem; letter-spacing:.18em; }
#netlbl  { position:absolute; top:14px; left:50%; transform:translateX(-50%);
  color:#0f8; font-size:.6rem; letter-spacing:.15em; }

#bossbar { position:absolute; top:46px; left:50%; transform:translateX(-50%);
  width:400px; display:none; flex-direction:column; align-items:center; gap:3px; }
#bossname{ color:#f44; font-size:.78rem; letter-spacing:.2em; animation:bossGlow .8s infinite alternate; }
#bosstrack { width:100%; height:11px; background:#110000; border:1px solid #f443; }
#bossfill  { height:100%; background:linear-gradient(90deg,#800,#f44); width:100%; transition:width .12s; }

#wann  { position:absolute; top:32%; left:50%; transform:translate(-50%,-50%);
  font-size:1.8rem; letter-spacing:.3em; color:#fff; text-shadow:0 0 25px #0ff;
  opacity:0; transition:opacity .4s; pointer-events:none; text-align:center; }
#wann.boss { color:#f44; text-shadow:0 0 25px #f44; }
#pmsg  { position:absolute; top:42%; left:50%; transform:translate(-50%,-50%);
  font-size:.95rem; letter-spacing:.12em; color:#ff0; text-shadow:0 0 12px #ff0;
  opacity:0; transition:opacity .3s; pointer-events:none; text-align:center; line-height:1.8; }
#wephint { position:absolute; bottom:78px; left:22px; font-size:.58rem; color:#ff0; display:none; }
#hitflash{ position:absolute; inset:0;
  background:radial-gradient(ellipse at center,transparent 40%,#f005 100%);
  opacity:0; pointer-events:none; transition:opacity .1s; }

/* ‚îÄ‚îÄ PAUSE/DEATH ‚îÄ‚îÄ */
#pausescreen { position:fixed; inset:0; background:rgba(0,0,0,.72); display:none;
  flex-direction:column; align-items:center; justify-content:center; z-index:15; }
#pausescreen h2 { color:#0ff; font-size:2.4rem; letter-spacing:.4em; text-shadow:0 0 18px #0ff; }
#pausescreen p { color:#555; margin-top:.7rem; font-size:.68rem; letter-spacing:.2em; }

#deathscreen { position:fixed; inset:0; background:rgba(0,0,0,.92); display:none;
  flex-direction:column; align-items:center; justify-content:center; z-index:20; }
#deathscreen h2 { color:#f44; font-size:2.6rem; letter-spacing:.3em; }
#deathscreen .stat { color:#888; margin-top:.5rem; }
#deathscreen .stat span { color:#0ff; }
#deathlb { margin-top:1.1rem; width:390px; border:1px solid #f443; padding:10px 14px; }
#deathlb h4 { color:#f44; font-size:.62rem; letter-spacing:.25em; margin-bottom:7px; text-align:center; }
#deathlb ul { list-style:none; }
#deathlb ul li { display:flex; justify-content:space-between; padding:4px; font-size:.7rem;
  border-bottom:1px solid #f441; }
#deathlb ul li .r{width:22px;} #deathlb ul li .n{flex:1;color:#ccc;}
#deathlb ul li .s{color:#0ff;} #deathlb ul li .w{color:#555;font-size:.58rem;margin-left:5px;}
#deathlb ul li.you .n,#deathlb ul li.you .s{color:#ff0;}
#deathlb ul li.g .r{color:#ffd700;} #deathlb ul li.sv .r{color:#c0c0c0;} #deathlb ul li.br .r{color:#cd7f32;}
.dbtns { display:flex; gap:10px; margin-top:1.1rem; }
.dbtn { padding:.52rem 1.6rem; background:transparent; border:2px solid #f44; color:#f44;
  font-family:"Courier New",monospace; font-size:.82rem; letter-spacing:.18em; cursor:pointer; transition:all .2s; }
.dbtn:hover{background:#f442;}
.dbtn.m{border-color:#0af;color:#0af;} .dbtn.m:hover{background:#0af2;}

@keyframes pulse { 0%,100%{text-shadow:0 0 20px #0ff,0 0 60px #0af;} 50%{text-shadow:0 0 40px #0ff,0 0 100px #0af,0 0 4px #fff;} }
@keyframes bossGlow { from{text-shadow:0 0 8px #f44;} to{text-shadow:0 0 22px #f44,0 0 4px #fff;} }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }
</style>
</head>
<body>
<audio id="mus-menu"   src="menu-disparos.mp3"           loop preload="auto"></audio>
<audio id="mus-spl"    src="sonido-shooter-jugador.mp3"       preload="auto"></audio>
<audio id="mus-ene"    src="shooter-enemigos.mp3"             preload="auto"></audio>
<audio id="mus-boss"   src="jefe-disparos.mp3"           loop preload="auto"></audio>
<audio id="mus-reload" src="recargar-disparos.mp3"            preload="auto"></audio>

<!-- OVERLAY -->
<div id="overlay">
  <h1>VOID HUNTER</h1>
  <p class="sub">ONLINE SHOOTER 3D</p>

  <div class="ctrl-cols">
    <div class="ctrl-col">
      <h4>CONTROLES</h4>
      <div class="ctrl-row"><span>WASD</span> Mover ¬∑ <span>MOUSE</span> Apuntar</div>
      <div class="ctrl-row"><span>CLICK</span> Disparar ¬∑ <span>R</span> Recargar</div>
      <div class="ctrl-row"><span>ESPACIO</span> Saltar ¬∑ <span>Q</span> Cambiar arma</div>
      <div class="ctrl-row"><span>P</span> Pausar</div>
    </div>
  </div>

  <div id="name-row">
    <div id="name-label">TU NOMBRE</div>
    <input id="player-name" type="text" maxlength="16" placeholder="JUGADOR" autocomplete="off" spellcheck="false">
    <div id="name-error"></div>
  </div>

  <div class="btn-row">
    <button class="btn" id="btnSolo">[ 1 JUGADOR ]</button>
    <button class="btn grn" id="btnOnline">[ ONLINE ]</button>
    <button class="btn sml" id="btnMusic">üîä M√öSICA</button>
  </div>

  <!-- NETWORK PANEL -->
  <div id="net-panel">
    <h3>‚îÄ MULTIJUGADOR ONLINE ‚îÄ</h3>
    <div id="net-status"></div>

    <!-- Step 1: choose create or join -->
    <div id="net-step0" style="display:flex;gap:8px;flex-direction:column;align-items:center;width:100%">
      <div class="btn-row" style="margin-top:0">
        <button class="btn grn sml" id="btnCreate">CREAR SALA</button>
        <button class="btn sml org" id="btnJoinMode">UNIRSE A SALA</button>
      </div>
    </div>

    <!-- Step 2a: host waiting -->
    <div id="net-step-host" style="display:none;flex-direction:column;align-items:center;gap:6px;width:100%">
      <div style="color:#888;font-size:.62rem;letter-spacing:.12em">COMPARTE ESTE C√ìDIGO:</div>
      <div id="room-code-display"></div>
      <div id="net-waiting">Esperando al jugador 2...</div>
      <button class="btn sml" id="btnCancelHost" style="margin-top:4px">CANCELAR</button>
    </div>

    <!-- Step 2b: guest join input -->
    <div id="net-step-guest" style="display:none;flex-direction:column;align-items:center;gap:8px;width:100%">
      <div style="color:#888;font-size:.62rem;letter-spacing:.12em">C√ìDIGO DE SALA:</div>
      <div class="net-row">
        <input id="room-code-input" type="text" maxlength="8" placeholder="ABC123" spellcheck="false">
        <button class="btn org sml" id="btnJoin">UNIRSE</button>
      </div>
      <button class="btn sml" id="btnCancelGuest">CANCELAR</button>
    </div>
  </div>

  <div id="lb-wrap">
    <h4>‚Äî TOP 5 PUNTAJES ‚Äî</h4>
    <ul id="lb-list"><li style="color:#334;font-size:.68rem;text-align:center;padding:8px;list-style:none">Sin puntajes a√∫n</li></ul>
  </div>
</div>

<!-- HUD -->
<div id="hud">
  <div id="xhair-p1"></div>
  <div id="xhair-p2"></div>
  <div class="phud" id="p1hud">
    <div class="plbl" id="p1namelbl">JUGADOR 1</div>
    <div class="hptrack"><div class="hpfill" id="p1hp"></div></div>
    <div class="weplbl" id="p1wep">PISTOLA</div>
    <div class="ammobig"><span id="p1ammo">15</span><span style="color:#444"> / </span><span id="p1res">90</span></div>
    <div class="rbar" id="p1rbar"></div>
  </div>
  <div class="phud" id="p2hud">
    <div class="plbl" id="p2namelbl">JUGADOR 2</div>
    <div class="hptrack"><div class="hpfill" id="p2hp"></div></div>
    <div class="weplbl" id="p2wep">PISTOLA</div>
    <div class="ammobig"><span id="p2ammo">15</span><span style="color:#444"> / </span><span id="p2res">90</span></div>
    <div class="rbar" id="p2rbar"></div>
  </div>
  <div id="score">SCORE: <span id="scoreval">0</span></div>
  <div id="waveinfo">OLA: <span id="waveval">1</span></div>
  <div id="maplbl">MAPA: <span id="mapname">CAMPO</span></div>
  <div id="netlbl"></div>
  <div id="bossbar"><div id="bossname">‚ö† JEFE ‚ö†</div><div id="bosstrack"><div id="bossfill"></div></div></div>
  <div id="wann"></div>
  <div id="pmsg"></div>
  <div id="wephint"></div>
  <div id="hitflash"></div>
</div>

<div id="pausescreen"><h2>‚è∏ PAUSA</h2><p>[ P ] para continuar</p></div>

<div id="deathscreen">
  <h2>ELIMINADO</h2>
  <div class="stat">SCORE: <span id="finalscore">0</span> &nbsp;¬∑&nbsp; OLA: <span id="finalwave">0</span></div>
  <div id="deathlb"><h4>‚Äî TOP 5 ‚Äî</h4><ul id="deathlblist"></ul></div>
  <div class="dbtns">
    <button class="dbtn" id="btnRetry">[ REINTENTAR ]</button>
    <button class="dbtn m"  id="btnMenu">[ MEN√ö ]</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCENE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);
scene.fog = new THREE.Fog(0xc9e8f0, 40, 120);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.body.appendChild(renderer.domElement);
window.addEventListener('resize', () => {
  renderer.setSize(innerWidth, innerHeight);
  players.forEach(p => { p.cam.aspect=innerWidth/innerHeight; p.cam.updateProjectionMatrix(); });
});

// DAY LIGHTING
const ambLight = new THREE.AmbientLight(0xffffff, .55);
scene.add(ambLight);
const sunLight = new THREE.DirectionalLight(0xfff4d0, 1.3);
sunLight.position.set(30,60,20); sunLight.castShadow=true;
sunLight.shadow.mapSize.set(2048,2048);
sunLight.shadow.camera.left=-60; sunLight.shadow.camera.right=60;
sunLight.shadow.camera.top=60;  sunLight.shadow.camera.bottom=-60;
scene.add(sunLight);
scene.add(new THREE.DirectionalLight(0xd0e8ff,.35));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAP THEMES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const THEMES=[
  {name:"CAMPO",   bg:0x87ceeb,fog:0xc9e8f0,floor:0x4a7c4e,sun:0xfff4d0},
  {name:"DESIERTO",bg:0xe8c97a,fog:0xf5e4b0,floor:0xc8a44a,sun:0xffee88},
  {name:"VOLCAN",  bg:0x2a0a00,fog:0x3a1000,floor:0x1a0500,sun:0xff4400},
  {name:"ARTICO",  bg:0xd0eeff,fog:0xe8f4ff,floor:0xddeeff,sun:0xeef8ff},
  {name:"SELVA",   bg:0x1a3a10,fog:0x2a5a18,floor:0x1a4010,sun:0x80ff40},
];
let currentTheme=0, floorMesh, arenaObjects=[];
function applyTheme(i){
  const t=THEMES[i%THEMES.length];
  scene.background.setHex(t.bg); scene.fog.color.setHex(t.fog);
  if(floorMesh) floorMesh.material.color.setHex(t.floor);
  sunLight.color.setHex(t.sun);
  document.getElementById("mapname").textContent=t.name;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ARENA (DAYTIME, REALISTIC OBSTACLES)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const obstacles=[];
function buildArena(){
  floorMesh=new THREE.Mesh(new THREE.PlaneGeometry(120,120),
    new THREE.MeshStandardMaterial({color:0x4a7c4e,roughness:.9}));
  floorMesh.rotation.x=-Math.PI/2; floorMesh.receiveShadow=true; scene.add(floorMesh);
  const mMetal=new THREE.MeshStandardMaterial({color:0x555560,roughness:.5,metalness:.7});
  const mConc =new THREE.MeshStandardMaterial({color:0x888880,roughness:.9});
  const mCrate=new THREE.MeshStandardMaterial({color:0x8B6914,roughness:.8});
  const mBrl  =new THREE.MeshStandardMaterial({color:0x224488,roughness:.5,metalness:.6});
  const mSand =new THREE.MeshStandardMaterial({color:0xc8a844,roughness:1});

  function addBox(x,z,w,h,d,mat,stand=true){
    const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),mat);
    m.position.set(x,h/2,z); m.castShadow=true; m.receiveShadow=true;
    scene.add(m); arenaObjects.push(m);
    obstacles.push({x,z,rx:w/2,rz:d/2,topY:h,canStand:stand});
  }
  function addCyl(x,z,r,h,mat){
    const m=new THREE.Mesh(new THREE.CylinderGeometry(r,r,h,10),mat);
    m.position.set(x,h/2,z); m.castShadow=true; scene.add(m); arenaObjects.push(m);
    obstacles.push({x,z,rx:r,rz:r,topY:h,canStand:true});
  }
  // Containers
  addBox(16,0,10,3,3,mMetal); addBox(-16,0,10,3,3,mMetal);
  addBox(0,18,3,3,10,mMetal); addBox(0,-18,3,3,10,mMetal);
  // Concrete barriers
  [[-8,8],[8,8],[-8,-8],[8,-8],[22,20],[-22,20],[22,-20],[-22,-20]].forEach(([x,z])=>addBox(x,z,4,1.4,1.2,mConc));
  // Sandbags
  [[-26,0],[26,0],[0,26],[0,-26]].forEach(([x,z])=>{
    const h=x===0; addBox(x,z,h?9:1.5,1,h?1.5:9,mSand);
  });
  // Crates
  [[11,11],[11,-11],[-11,11],[-11,-11]].forEach(([x,z])=>{
    addBox(x,z,1.2,1.2,1.2,mCrate); addBox(x+1.3,z,1.2,1.2,1.2,mCrate);
  });
  // Barrels
  [[-32,10],[32,10],[32,-10],[-32,-10],[13,26],[-13,26],[13,-26],[-13,-26]].forEach(([x,z])=>{
    addCyl(x,z,.42,1.1,mBrl); if(Math.random()>.5) addCyl(x+1,z,.42,1.1,mBrl);
  });
  // Elevated platforms
  addBox(32,0,8,2.5,8,mConc); addBox(-32,0,8,2.5,8,mConc);
  // Walls (invisible)
  const inv=new THREE.MeshBasicMaterial({visible:false});
  [[0,0,-54],[0,0,54],[-54,0,0],[54,0,0]].forEach(([x,y,z],i)=>{
    const m=new THREE.Mesh(new THREE.BoxGeometry(i<2?110:2,20,i<2?2:110),inv);
    m.position.set(x,y,z); scene.add(m);
    obstacles.push({x,z,rx:i<2?55:1,rz:i<2?1:55,topY:20,canStand:false});
  });
  applyTheme(0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEAPONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WEAPONS={
  pistol:{name:"PISTOLA",      ammo:15,reserve:90, damage:28,cd:.22,shots:1,spread:.012},
  dual:  {name:"DOBLE PISTOLA",ammo:30,reserve:150,damage:22,cd:.16,shots:2,spread:.06 },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAYERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EYE_H=1.7, GRAVITY=-22, JUMP_V=9;
function makePlayer(id,sx){
  const cam=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,200);
  cam.position.set(sx,EYE_H,0);
  return{id,cam,pitch:0,yaw:id===1?0:Math.PI,velY:0,onGround:true,
    health:100,weapon:"pistol",weaponUnlocked:{pistol:true,dual:false},
    ammo:WEAPONS.pistol.ammo,reserve:WEAPONS.pistol.reserve,
    reloading:false,canShoot:true,shootCd:0,recoil:0,bob:0,bobT:0,alive:true,mesh:null};
}
const players=[makePlayer(1,2),makePlayer(2,-2)];

function buildPlayerMesh(col){
  const g=new THREE.Group();
  const m=new THREE.MeshStandardMaterial({color:col,roughness:.6});
  const d=new THREE.MeshStandardMaterial({color:0x222222,roughness:.8});
  const body=new THREE.Mesh(new THREE.BoxGeometry(.5,.8,.35),m); body.position.y=.4; g.add(body);
  const head=new THREE.Mesh(new THREE.BoxGeometry(.32,.32,.32),d); head.position.y=1.0; g.add(head);
  const viz=new THREE.Mesh(new THREE.BoxGeometry(.22,.1,.04),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:.9}));
  viz.position.set(0,1.02,.18); g.add(viz);
  return g;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let score=0,wave=1,bossesDefeated=0;
let enemies=[],bullets=[],particles=[],eBullets=[];
let gameActive=false,gamePaused=false,gameStarted=false;
let waveTimer=0,enemiesThisWave=0,enemiesKilled=0;
let bossAlive=false,bossRef=null,waveComplete=false;
let enemyIdCtr=0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NETWORKING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let peer=null, netConn=null, netRole=null; // "host"|"guest"|null
const guestMeshes=new Map(); // id -> mesh (for guest rendering)
let guestBullets=[];       // bullet meshes on guest side
let hostMesh=null;         // visible mesh of host player (seen by guest)
let guestShoot=false, guestReload=false;
let netSendTimer=0;

function netStatus(msg,cls=""){
  const el=document.getElementById("net-status");
  el.textContent=msg; el.className=cls;
}

function showNetPanel(){ document.getElementById("net-panel").classList.add("show"); }
function hideNetPanel(){ document.getElementById("net-panel").classList.remove("show"); }

function netShowStep(step){
  ["net-step0","net-step-host","net-step-guest"].forEach(id=>{
    document.getElementById(id).style.display="none";
  });
  document.getElementById(step).style.display="flex";
}

function createRoom(){
  const name=document.getElementById("player-name").value.trim();
  if(!name){ showNameError(); return; }
  const code=Math.random().toString(36).slice(2,8).toUpperCase();
  netStatus("Conectando...");
  peer=new Peer(code,{debug:0});
  peer.on("open",id=>{
    document.getElementById("room-code-display").textContent=id;
    netShowStep("net-step-host");
    netStatus("Esperando al jugador 2...");
  });
  peer.on("connection",conn=>{
    netConn=conn; netRole="host";
    netStatus("¬°Conectado! Iniciando...","ok");
    conn.on("open",()=>{
      setTimeout(()=>{
        // Tell guest to start
        conn.send({type:"start"});
        startOnlineGame("host");
      },800);
    });
    conn.on("data",d=>handleGuestInput(d));
    conn.on("close",()=>{ if(gameActive) showMsg("‚ö† Jugador 2 desconectado"); });
  });
  peer.on("error",e=>{
    netStatus("Error: "+e.type+". Intenta de nuevo.","err");
    netShowStep("net-step0");
  });
}

function joinRoom(){
  const name=document.getElementById("player-name").value.trim();
  if(!name){ showNameError(); return; }
  const code=document.getElementById("room-code-input").value.trim().toUpperCase();
  if(!code){ netStatus("‚ö† Ingresa el c√≥digo","err"); return; }
  netStatus("Conectando a "+code+"...");
  peer=new Peer({debug:0});
  peer.on("open",()=>{
    netConn=peer.connect(code);
    netRole="guest";
    netConn.on("open",()=>{ netStatus("¬°Conectado! Esperando inicio...","ok"); });
    netConn.on("data",d=>{
      if(d.type==="start") startOnlineGame("guest");
      else applyHostState(d);
    });
    netConn.on("close",()=>{ if(gameActive) endGame(); });
  });
  peer.on("error",e=>{
    netStatus("No se pudo conectar. Verific√° el c√≥digo.","err");
  });
}

function cancelNet(){
  if(peer){ try{peer.destroy();}catch(e){} peer=null; }
  netConn=null; netRole=null;
  netShowStep("net-step0"); netStatus("");
}

// Host: send state to guest
function sendHostState(){
  if(!netConn||!netConn.open||netRole!=="host") return;
  const state={
    p1:{x:+players[0].cam.position.x.toFixed(2),y:+players[0].cam.position.y.toFixed(2),
        z:+players[0].cam.position.z.toFixed(2),h:players[0].health,
        yaw:+players[0].yaw.toFixed(3)},
    p2:{h:players[1].health,ammo:players[1].ammo,res:players[1].reserve,
        wep:players[1].weapon,reloading:players[1].reloading},
    enemies:enemies.map(e=>({
      id:e.id, x:+e.mesh.position.x.toFixed(2), y:+e.mesh.position.y.toFixed(2),
      z:+e.mesh.position.z.toFixed(2), ry:+e.mesh.rotation.y.toFixed(3),
      hp:Math.round(e.hp), mhp:e.maxHp, boss:e.isBoss?1:0,
      col:e.isBoss?(e.def?e.def.color:0xff0000):ECOLORS[wave%ECOLORS.length],
      defIdx:e.isBoss?(bossesDefeated%BOSS_DEFS.length):-1
    })),
    ebs:eBullets.map(b=>({
      x:+b.mesh.position.x.toFixed(2),y:+b.mesh.position.y.toFixed(2),
      z:+b.mesh.position.z.toFixed(2),boss:b.isBoss?1:0
    })),
    score,wave,gameActive,gamePaused,
    bossHp:bossRef?Math.round(bossRef.hp):0,
    bossMaxHp:bossRef?bossRef.maxHp:0,
    bossName:bossRef&&bossRef.def?bossRef.def.name:""
  };
  netConn.send(state);
}

// Guest: apply host state for rendering
function applyHostState(state){
  if(!gameStarted) return;
  score=state.score; wave=state.wave;
  gamePaused=state.gamePaused;
  if(!gamePaused) gameActive=state.gameActive;

  // P2 HUD (guest player)
  players[1].health=state.p2.h;
  players[1].ammo=state.p2.ammo; players[1].reserve=state.p2.res;
  players[1].weapon=state.p2.wep; players[1].reloading=state.p2.reloading;

  // Boss bar
  if(state.bossName&&state.bossHp>0){
    document.getElementById("bossbar").style.display="flex";
    document.getElementById("bossname").textContent="‚ö†  "+state.bossName+"  ‚ö†";
    document.getElementById("bossfill").style.width=Math.max(0,state.bossHp/state.bossMaxHp*100)+"%";
  } else {
    document.getElementById("bossbar").style.display="none";
  }

  // Sync enemy meshes
  const ids=new Set(state.enemies.map(e=>e.id));
  for(const [id,data] of guestMeshes){
    if(!ids.has(id)){ spawnExplosion(data.mesh.position.clone(),0xff4400,14); scene.remove(data.mesh); guestMeshes.delete(id); }
  }
  state.enemies.forEach(e=>{
    if(!guestMeshes.has(e.id)){
      const m=buildHumanoid(e.col,e.boss?1.8:1);
      if(e.boss&&e.defIdx>=0) BOSS_DEFS[e.defIdx].build(m,e.col);
      scene.add(m); guestMeshes.set(e.id,{mesh:m,isBoss:e.boss});
    }
    const md=guestMeshes.get(e.id).mesh;
    md.position.set(e.x,e.y,e.z); md.rotation.y=e.ry;
  });

  // Enemy bullets (recreate each frame - they are transient)
  guestBullets.forEach(b=>scene.remove(b)); guestBullets.length=0;
  state.ebs.forEach(b=>{
    const g2=new THREE.CylinderGeometry(.04,.04,1.5,5); g2.rotateX(Math.PI/2);
    const m=new THREE.Mesh(g2,new THREE.MeshBasicMaterial({color:b.boss?0xff6600:0xff2200}));
    m.position.set(b.x,b.y,b.z); scene.add(m); guestBullets.push(m);
  });

  // Host player visible mesh
  if(hostMesh){ hostMesh.position.set(state.p1.x,state.p1.y-EYE_H,state.p1.z); hostMesh.rotation.y=state.p1.yaw+Math.PI; }
  if(!state.gameActive&&gameStarted) endGame();
  updateHUD();
}

// Host: receive guest input
function handleGuestInput(d){
  if(d.type!=="input") return;
  // Guest sends their own position (client-authoritative movement)
  players[1].cam.position.set(d.x,d.y,d.z);
  players[1].yaw=d.yaw; players[1].pitch=d.pitch;
  if(d.shoot) doShoot(players[1]);
  if(d.reload) tryReload(players[1]);
}

// Guest: send my position + actions to host
function sendGuestInput(){
  if(!netConn||!netConn.open||netRole!=="guest") return;
  const p=players[1]; // guest is players[1] locally but controls their own cam
  netConn.send({
    type:"input",
    x:+p.cam.position.x.toFixed(2), y:+p.cam.position.y.toFixed(2), z:+p.cam.position.z.toFixed(2),
    yaw:p.yaw, pitch:p.pitch,
    shoot:guestShoot, reload:guestReload
  });
  guestShoot=false; guestReload=false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INPUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const keys={};
document.addEventListener("keydown",e=>{
  keys[e.code]=true;
  if(!gameStarted) return;
  if(e.code==="KeyP") togglePause();
  if(gamePaused) return;
  if(netRole!=="guest"){
    if(e.code==="KeyR") tryReload(players[0]);
    if(e.code==="KeyQ") cycleWeapon(players[0]);
  } else {
    if(e.code==="KeyR"){ guestReload=true; tryReload(players[1]); }
    if(e.code==="KeyQ") cycleWeapon(players[1]);
  }
});
document.addEventListener("keyup",e=>keys[e.code]=false);
document.addEventListener("mousemove",e=>{
  if(!gameActive||gamePaused) return;
  const p=netRole==="guest"?players[1]:players[0];
  p.yaw-=e.movementX*.002;
  p.pitch=Math.max(-1.1,Math.min(1.1,p.pitch-e.movementY*.002));
});
document.addEventListener("click",()=>{
  if(!gameActive||gamePaused) return;
  if(netRole==="guest"){ guestShoot=true; doShoot(players[1]); }
  else doShoot(players[0]);
});
document.addEventListener("wheel",()=>{
  if(gameActive&&!gamePaused){
    const p=netRole==="guest"?players[1]:players[0];
    cycleWeapon(p);
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PHYSICS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function resolvePhysics(p,dt){
  const fwd=new THREE.Vector3(-Math.sin(p.yaw),0,-Math.cos(p.yaw));
  const rgt=new THREE.Vector3(Math.cos(p.yaw),0,-Math.sin(p.yaw));
  const spd=keys["ShiftLeft"]&&netRole!=="guest"?8:5;
  const mv=new THREE.Vector3();
  if(keys["KeyW"]) mv.addScaledVector(fwd,spd);
  if(keys["KeyS"]) mv.addScaledVector(fwd,-spd);
  if(keys["KeyA"]) mv.addScaledVector(rgt,-spd);
  if(keys["KeyD"]) mv.addScaledVector(rgt,spd);
  if(keys["Space"]&&p.onGround){ p.velY=JUMP_V; p.onGround=false; }

  let nx=p.cam.position.x+mv.x*dt;
  let nz=p.cam.position.z+mv.z*dt;
  nx=Math.max(-52,Math.min(52,nx)); nz=Math.max(-52,Math.min(52,nz));

  p.velY+=GRAVITY*dt;
  let ny=p.cam.position.y+p.velY*dt;
  let standY=EYE_H; p.onGround=false;

  for(const ob of obstacles){
    const ddx=Math.abs(nx-ob.x)-ob.rx;
    const ddz=Math.abs(nz-ob.z)-ob.rz;
    const feetY=p.cam.position.y-EYE_H;
    if(ddx<.35&&ddz<.35){
      if(ob.canStand&&feetY>=ob.topY-.4&&p.velY<=.1){
        standY=Math.max(standY,ob.topY+EYE_H);
      } else {
        if(ddx>ddz) nz=p.cam.position.z; else nx=p.cam.position.x;
      }
    }
  }
  if(ny<=standY){ ny=standY; p.velY=0; p.onGround=true; }
  p.cam.position.set(nx,ny,nz);

  p.recoil+=(-p.recoil)*Math.min(1,dt*14);
  const mov2=mv.lengthSq()>.01;
  p.bobT+=mov2?dt*8:dt*4;
  p.bob=mov2?Math.sin(p.bobT)*.01:p.bob*.85;
  p.cam.rotation.order="YXZ";
  p.cam.rotation.y=p.yaw;
  p.cam.rotation.x=p.pitch+p.recoil+p.bob*.4;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEAPONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cycleWeapon(p){
  const av=Object.keys(p.weaponUnlocked).filter(k=>p.weaponUnlocked[k]);
  if(av.length<2) return;
  p.weapon=av[(av.indexOf(p.weapon)+1)%av.length];
  const wp=WEAPONS[p.weapon]; p.ammo=wp.ammo; p.reserve=wp.reserve; p.reloading=false;
  showMsg("["+wp.name+"]"); updateHUD();
}

function tryReload(p){
  if(p.reloading||p.reserve<=0||p.ammo>=WEAPONS[p.weapon].ammo) return;
  p.reloading=true; playBuf("reload",.7);
  const bar=document.getElementById("p"+p.id+"rbar");
  bar.style.transition="width 0s"; bar.style.width="0";
  setTimeout(()=>{ bar.style.transition="width 1.4s linear"; bar.style.width="110px"; },10);
  setTimeout(()=>{
    const wp=WEAPONS[p.weapon],take=Math.min(wp.ammo-p.ammo,p.reserve);
    p.ammo+=take; p.reserve-=take; p.reloading=false;
    bar.style.transition="width 0s"; bar.style.width="0"; updateHUD();
  },1500);
}

function doShoot(p){
  if(!gameActive||gamePaused||!p.alive||!p.canShoot||p.reloading||p.ammo<=0){
    if(p.ammo<=0&&p.reserve>0) tryReload(p);
    return;
  }
  const wp=WEAPONS[p.weapon];
  p.ammo=Math.max(0,p.ammo-wp.shots); p.recoil-=wp.spread*3;
  updateHUD(); playBuf("player",.6);
  document.getElementById("hitflash").style.opacity=".18";
  setTimeout(()=>document.getElementById("hitflash").style.opacity="0",55);
  for(let s=0;s<wp.shots;s++){
    const ox=wp.shots>1?(s===0?-wp.spread:wp.spread):0;
    const dir=new THREE.Vector3(ox+(Math.random()-.5)*.008,0,-1).normalize();
    dir.applyEuler(new THREE.Euler(p.pitch+p.recoil,p.yaw,0,"YXZ"));
    let hit=null,minD=Infinity;
    enemies.forEach(en=>{
      const c=en.mesh.position.clone().setY(en.isBoss?2:.95);
      const toE=c.clone().sub(p.cam.position); const d=toE.length();
      const dot=dir.dot(toE.normalize());
      const perp=Math.sqrt(Math.max(0,1-dot*dot))*d;
      if(dot>.1&&perp<(en.isBoss?2:.95)&&d<minD){minD=d;hit=en;}
    });
    if(hit){
      hit.hp-=wp.damage+Math.random()*8;
      spawnHitFx(hit.mesh.position.clone().setY(hit.isBoss?2:.95));
      if(hit.hp<=0) killEnemy(hit); else if(hit.isBoss) updateBossBar(hit);
    }
    spawnTracer(p.cam.position.clone(),dir);
  }
  p.canShoot=false; p.shootCd=wp.cd;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENEMIES ‚Äî HUMANOID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ECOLORS=[0xcc2020,0xdd6600,0x8800cc,0xcc0077,0x00aa88];

function buildHumanoid(col,sc=1){
  const g=new THREE.Group();
  const arm=new THREE.MeshStandardMaterial({color:col,emissive:col,emissiveIntensity:.15,roughness:.4,metalness:.6});
  const drk=new THREE.MeshStandardMaterial({color:0x181818,roughness:.8});
  const viz=new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:.92});
  // Boots
  [-.18,.18].forEach(lx=>{
    const b=new THREE.Mesh(new THREE.BoxGeometry(.16,.1,.24),drk);
    b.position.set(lx*.6*sc,.05*sc,.04*sc); g.add(b);
  });
  // Shins
  [-.18,.18].forEach(lx=>{
    const s=new THREE.Mesh(new THREE.CylinderGeometry(.07,.08,.42,6),drk);
    s.position.set(lx*.6*sc,.32*sc,0); g.add(s);
  });
  // Thighs
  [-.18,.18].forEach(lx=>{
    const t=new THREE.Mesh(new THREE.CylinderGeometry(.1,.09,.44,6),arm);
    t.position.set(lx*.5*sc,.65*sc,0); g.add(t);
  });
  // Torso
  const to=new THREE.Mesh(new THREE.BoxGeometry(.6,.62,.38),arm); to.position.y=.98*sc; g.add(to);
  const pl=new THREE.Mesh(new THREE.BoxGeometry(.38,.32,.05),drk); pl.position.set(0,.98*sc,.22*sc); g.add(pl);
  const bl=new THREE.Mesh(new THREE.BoxGeometry(.62,.1,.4),drk); bl.position.y=.68*sc; g.add(bl);
  // Arms
  [-.4,.4].forEach(ax=>{
    const u=new THREE.Mesh(new THREE.CylinderGeometry(.09,.08,.38,6),arm);
    u.position.set(ax*sc,.9*sc,0); u.rotation.z=ax>0?.3:-.3; g.add(u);
    const lo=new THREE.Mesh(new THREE.CylinderGeometry(.07,.06,.32,6),drk);
    lo.position.set((ax+(ax>0?.1:-.1))*sc,.68*sc,.05*sc); lo.rotation.z=ax>0?.5:-.5; g.add(lo);
    const gn=new THREE.Mesh(new THREE.BoxGeometry(.07,.07,.28),new THREE.MeshStandardMaterial({color:0x333333,metalness:.9}));
    gn.position.set((ax+(ax>0?.18:-.18))*sc,.55*sc,.12*sc); g.add(gn);
  });
  // Neck + Head + Helmet
  const nk=new THREE.Mesh(new THREE.CylinderGeometry(.09,.11,.13,6),drk); nk.position.y=1.34*sc; g.add(nk);
  const hm=new THREE.Mesh(new THREE.BoxGeometry(.38,.38,.38),arm); hm.position.y=1.6*sc; g.add(hm);
  const th=new THREE.Mesh(new THREE.BoxGeometry(.34,.12,.34),drk); th.position.y=1.81*sc; g.add(th);
  const vs=new THREE.Mesh(new THREE.BoxGeometry(.26,.09,.05),viz); vs.position.set(0,1.62*sc,.2*sc); g.add(vs);
  const el=new THREE.PointLight(col,.7,2.5); el.position.set(0,1.62*sc,.25*sc); g.add(el);
  const an=new THREE.Mesh(new THREE.CylinderGeometry(.01,.01,.22,4),new THREE.MeshBasicMaterial({color:col}));
  an.position.set(.12,1.95*sc,0); g.add(an);
  return g;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOSS DEFINITIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BOSS_DEFS=[
  { name:"‚ò† TITAN",   color:0xcc2200,scale:2.0,baseHp:1000,hpW:300,baseSpd:.9, si:1.4,pat:"burst3",
    build:(g,c)=>{
      [[-1.8,1.8]].flat().forEach(sx=>{
        const sp=new THREE.Mesh(new THREE.BoxGeometry(1.2,.9,1),new THREE.MeshStandardMaterial({color:0x880000,metalness:.7}));
        sp.position.set(sx*1.2,3.2,0); g.add(sp);
      });
      const can=new THREE.Mesh(new THREE.CylinderGeometry(.22,.28,1.2,8),new THREE.MeshStandardMaterial({color:0x222222,metalness:.9}));
      can.rotation.x=Math.PI/2; can.position.set(0,2.2,.8); g.add(can);
    }
  },
  { name:"üëÅ PHANTOM", color:0x8800ff,scale:1.5,baseHp:800, hpW:400,baseSpd:2.8,si:.5, pat:"rapid",
    build:(g,c)=>{
      [[-1,1]].flat().forEach(sx=>{
        const f=new THREE.Mesh(new THREE.BoxGeometry(.1,2.5,.8),new THREE.MeshStandardMaterial({color:c,emissive:c,emissiveIntensity:.6,transparent:true,opacity:.7}));
        f.position.set(sx*1.2,1.2,-.4); g.add(f);
      });
      const orb=new THREE.Mesh(new THREE.SphereGeometry(.35,10,10),new THREE.MeshBasicMaterial({color:0xcc88ff}));
      orb.position.set(0,2.2,.5); g.add(orb);
      const ol=new THREE.PointLight(0xaa44ff,2,5); ol.position.copy(orb.position); g.add(ol);
    }
  },
  { name:"üíÄ BEHEMOTH",color:0x226600,scale:2.5,baseHp:1800,hpW:600,baseSpd:.7, si:2.0,pat:"shotgun6",
    build:(g,c)=>{
      [[-1,1]].flat().forEach(sx=>{
        const cl=new THREE.Mesh(new THREE.CylinderGeometry(.4,.25,2.2,8),new THREE.MeshStandardMaterial({color:0x114400,roughness:.9}));
        cl.position.set(sx*1.8,.8,0); cl.rotation.z=sx>.0?.6:-.6; g.add(cl);
      });
      [-.6,0,.6].forEach(sx=>{
        const sp=new THREE.Mesh(new THREE.CylinderGeometry(.05,.2,.9,5),new THREE.MeshStandardMaterial({color:0x445500}));
        sp.position.set(sx,4.5,-.4); g.add(sp);
      });
    }
  },
  { name:"‚ö° SPECTER", color:0x00aaff,scale:1.7,baseHp:1200,hpW:500,baseSpd:1.8,si:.8, pat:"spread5",
    build:(g,c)=>{
      [[-1,1]].flat().forEach(sx=>{
        const rd=new THREE.Mesh(new THREE.CylinderGeometry(.04,.04,1.8,4),new THREE.MeshBasicMaterial({color:0x00ffff}));
        rd.position.set(sx*.9,4.2,0); g.add(rd);
        const bl=new THREE.Mesh(new THREE.SphereGeometry(.18,8,8),new THREE.MeshBasicMaterial({color:0xffffff}));
        bl.position.set(sx*.9,5.3,0); g.add(bl);
      });
      g.add(new THREE.PointLight(0x00aaff,3,7));
    }
  },
  { name:"üî• VOID LORD",color:0xff4400,scale:2.2,baseHp:2500,hpW:800,baseSpd:1.6,si:.45,pat:"voidlord",
    build:(g,c)=>{
      for(let i=0;i<8;i++){
        const a=(i/8)*Math.PI*2;
        const sp=new THREE.Mesh(new THREE.CylinderGeometry(.04,.16,.7,5),new THREE.MeshStandardMaterial({color:0xff6600,emissive:0xff2200,emissiveIntensity:.8}));
        sp.position.set(Math.cos(a)*.5,5.2,Math.sin(a)*.5); g.add(sp);
      }
      [[-1.6,1.6]].flat().forEach(sx=>{
        const br=new THREE.Mesh(new THREE.CylinderGeometry(.15,.2,1.4,8),new THREE.MeshStandardMaterial({color:0x111111,metalness:.9}));
        br.rotation.x=Math.PI/2; br.position.set(sx*1.3,3,.7); g.add(br);
      });
      const gl=new THREE.PointLight(0xff4400,4,10); gl.position.set(0,2.5,0); g.add(gl);
    }
  }
];

function spawnEnemy(){
  const a=Math.random()*Math.PI*2, d=30+Math.random()*15;
  const x=Math.cos(a)*d, z=Math.sin(a)*d;
  const col=ECOLORS[wave%ECOLORS.length];
  const g=buildHumanoid(col); g.position.set(x,0,z); scene.add(g);
  const diff=bossesDefeated*.2;
  const hp=Math.floor((80+wave*30)*(1+diff));
  const spd=1.5+wave*.25+bossesDefeated*.15;
  enemies.push({id:enemyIdCtr++,mesh:g,hp,maxHp:hp,speed:spd,
    shootTimer:1+Math.random()*2,isBoss:false,walkT:Math.random()*6});
  enemiesThisWave++;
}

function spawnBoss(){
  const a=Math.random()*Math.PI*2;
  const defIdx=bossesDefeated%BOSS_DEFS.length;
  const def=BOSS_DEFS[defIdx];
  const difficulty=Math.floor(bossesDefeated/BOSS_DEFS.length);
  const hp=Math.floor((def.baseHp+def.hpW*wave)*(1+difficulty*.5));
  const spd=def.baseSpd+wave*.15+difficulty*.3;
  const si=Math.max(.3,def.si-difficulty*.08);
  const g=buildHumanoid(def.color,def.scale);
  def.build(g,def.color);
  g.position.set(Math.cos(a)*42,0,Math.sin(a)*42); scene.add(g);
  const boss={id:enemyIdCtr++,mesh:g,hp,maxHp:hp,speed:spd,shootTimer:si,
    isBoss:true,walkT:0,def,difficulty,si,minionSpawned:false};
  enemies.push(boss); bossRef=boss; bossAlive=true; enemiesThisWave++;
  document.getElementById("bossbar").style.display="flex";
  document.getElementById("bossname").textContent="‚ö†  "+def.name+"  ‚Äî OLA "+wave+"  ‚ö†";
  updateBossBar(boss); startBossMusic();
  showMsg(def.name+"\n¬°PREP√ÅRENSE!");
}

function updateBossBar(b){
  document.getElementById("bossfill").style.width=Math.max(0,b.hp/b.maxHp*100)+"%";
}

function nearestPlayer(pos){
  let best=null,bestD=Infinity;
  players.forEach(p=>{
    if(!p.alive) return;
    const d=pos.distanceTo(p.cam.position);
    if(d<bestD){bestD=d;best=p;}
  });
  return best;
}

function updateEnemies(dt){
  enemies.forEach(en=>{
    const tgt=nearestPlayer(en.mesh.position); if(!tgt) return;
    const dx=tgt.cam.position.x-en.mesh.position.x;
    const dz=tgt.cam.position.z-en.mesh.position.z;
    const dist=Math.sqrt(dx*dx+dz*dz);
    const nx=dx/dist, nz=dz/dist;

    if(en.isBoss){
      const pat=en.def.attackPattern||en.def.pat;
      if(pat==="rapid"&&dist>15&&Math.random()<dt*.6){
        const ang=Math.random()*Math.PI*2;
        en.mesh.position.x=tgt.cam.position.x+Math.cos(ang)*8;
        en.mesh.position.z=tgt.cam.position.z+Math.sin(ang)*8;
      } else {
        const ch=(pat==="shotgun6"&&dist<18)?2.2:1;
        en.mesh.position.x+=nx*en.speed*ch*dt;
        en.mesh.position.z+=nz*en.speed*ch*dt;
      }
      en.mesh.position.y=Math.sin(Date.now()*.0015)*.2;
    } else {
      en.mesh.position.x+=nx*en.speed*dt;
      en.mesh.position.z+=nz*en.speed*dt;
      en.walkT+=dt*7;
      en.mesh.position.y=Math.abs(Math.sin(en.walkT))*.1;
      en.mesh.rotation.x=.1;
    }
    en.mesh.lookAt(tgt.cam.position.clone().setY(en.isBoss?1.8:.9));

    en.shootTimer-=dt;
    if(en.shootTimer<=0){
      if(en.isBoss){
        const pat2=en.def.pat;
        // Specter minion spawn
        if(pat2==="spread5"&&!en.minionSpawned&&en.hp<en.maxHp*.5){
          en.minionSpawned=true;
          for(let m=0;m<2;m++) setTimeout(()=>spawnEnemy(),m*400);
          showMsg("‚ö° SPECTER INVOCA REFUERZOS");
        }
        if(dist<4.5){ takeDamage(tgt,20+wave*4+en.difficulty*5); }
        else if(dist<55){
          const pos=en.mesh.position.clone();
          if(pat2==="burst3"){
            for(let s=0;s<3;s++) setTimeout(()=>spawnEB(en.mesh.position.clone(),nx+(s-1)*.08,nz,true,tgt),s*100);
          } else if(pat2==="rapid"){
            spawnEB(pos,nx+(Math.random()-.5)*.04,nz+(Math.random()-.5)*.04,true,tgt);
          } else if(pat2==="shotgun6"){
            for(let s=0;s<6;s++){
              const ang2=(s/6)*Math.PI*.7-.35;
              spawnEB(pos.clone(),nx*Math.cos(ang2)-nz*Math.sin(ang2),nx*Math.sin(ang2)+nz*Math.cos(ang2),true,tgt);
            }
          } else if(pat2==="spread5"){
            for(let s=0;s<5;s++) spawnEB(pos.clone(),nx+(s-2)*.1,nz,true,tgt);
          } else if(pat2==="voidlord"){
            for(let s=0;s<4;s++) setTimeout(()=>spawnEB(en.mesh.position.clone(),nx+(s-1.5)*.12,nz,true,tgt),s*80);
          }
        }
        en.shootTimer=en.si+Math.random()*.3;
      } else {
        if(dist<2.5) takeDamage(tgt,18+wave*2);
        else if(dist<45) spawnEB(en.mesh.position.clone(),nx,nz,false,tgt);
        en.shootTimer=1.3+Math.random();
      }
    }
  });
}

function killEnemy(en){
  const wasBoss=en.isBoss;
  spawnExplosion(en.mesh.position.clone(),wasBoss?0xff4400:ECOLORS[wave%ECOLORS.length],wasBoss?50:18);
  scene.remove(en.mesh); enemies.splice(enemies.indexOf(en),1);
  score+=wasBoss?600*wave:100*wave; enemiesKilled++;
  if(wasBoss){
    bossAlive=false; bossRef=null; bossesDefeated++;
    stopBossMusic();
    document.getElementById("bossbar").style.display="none";
    currentTheme++; applyTheme(currentTheme);
    players.forEach(p=>{ if(!p.weaponUnlocked.dual) p.weaponUnlocked.dual=true; p.health=Math.min(100,p.health+35); });
    document.getElementById("wephint").textContent="üî´ DOBLE PISTOLA ‚Äî [ Q ] equipar";
    document.getElementById("wephint").style.display="block";
    setTimeout(()=>document.getElementById("wephint").style.display="none",3000);
    const msgs=["üíÄ ¬°JEFE DERROTADO!","‚ö† ¬°DIFICULTAD AUMENTADA!","üî• ¬°EST√ÅN FURIOSOS!","‚ò† ¬°RESISTENCIA TOTAL!","üëÅ ¬°MODO INFIERNO!"];
    setTimeout(()=>showMsg(msgs[Math.min(bossesDefeated-1,msgs.length-1)]),1600);
  }
  document.getElementById("hitflash").style.opacity=".15";
  setTimeout(()=>document.getElementById("hitflash").style.opacity="0",180);
  updateHUD();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENEMY BULLETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function spawnEB(pos,dx,dz,isBoss,tgt){
  playBuf("enemy",.28);
  const ln=Math.sqrt(dx*dx+dz*dz)||1; const nx2=dx/ln,nz2=dz/ln;
  const geo=new THREE.CylinderGeometry(isBoss?.055:.035,isBoss?.055:.035,isBoss?2.2:1.5,5);
  geo.rotateX(Math.PI/2);
  const m=new THREE.Mesh(geo,new THREE.MeshBasicMaterial({color:isBoss?0xff6600:0xff2200,transparent:true,opacity:.88}));
  pos.y=1.2; m.position.copy(pos); m.rotation.y=-Math.atan2(nz2,nx2)+Math.PI/2;
  scene.add(m);
  eBullets.push({mesh:m,vx:nx2*(isBoss?14:10),vz:nz2*(isBoss?14:10),life:4,dmg:isBoss?16:10,tgt,isBoss});
}
function updateEBullets(dt){
  for(let i=eBullets.length-1;i>=0;i--){
    const b=eBullets[i];
    b.mesh.position.x+=b.vx*dt; b.mesh.position.z+=b.vz*dt; b.life-=dt;
    if(b.tgt&&b.tgt.alive){
      const ddx=b.mesh.position.x-b.tgt.cam.position.x;
      const ddz=b.mesh.position.z-b.tgt.cam.position.z;
      if(Math.sqrt(ddx*ddx+ddz*ddz)<.7){
        takeDamage(b.tgt,b.dmg); scene.remove(b.mesh); eBullets.splice(i,1); continue;
      }
    }
    if(b.life<=0){scene.remove(b.mesh);eBullets.splice(i,1);}
  }
}

function takeDamage(p,amt){
  if(!p.alive) return;
  p.health=Math.max(0,p.health-amt);
  document.getElementById("hitflash").style.opacity=".5";
  setTimeout(()=>document.getElementById("hitflash").style.opacity="0",120);
  updateHUD();
  if(p.health<=0){
    p.alive=false;
    if(players.filter(pp=>pp.alive).length===0) endGame();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VFX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function spawnTracer(from,dir){
  const g2=new THREE.CylinderGeometry(.012,.012,2.8,4); g2.rotateX(Math.PI/2);
  const m=new THREE.Mesh(g2,new THREE.MeshBasicMaterial({color:0xffee88,transparent:true,opacity:.8}));
  m.position.copy(from.clone().add(dir.clone().multiplyScalar(1.4)));
  m.lookAt(from.clone().add(dir)); scene.add(m);
  bullets.push({mesh:m,life:.07});
}
function updateTracers(dt){
  for(let i=bullets.length-1;i>=0;i--){ bullets[i].life-=dt; if(bullets[i].life<=0){scene.remove(bullets[i].mesh);bullets.splice(i,1);} }
}
function spawnHitFx(pos){
  for(let i=0;i<8;i++){
    const p=new THREE.Mesh(new THREE.SphereGeometry(.05,4,4),new THREE.MeshBasicMaterial({color:0xff4444}));
    p.position.copy(pos); scene.add(p);
    particles.push({mesh:p,v:new THREE.Vector3((Math.random()-.5)*6,Math.random()*6,(Math.random()-.5)*6),life:.35});
  }
}
function spawnExplosion(pos,color,cnt=18){
  for(let i=0;i<cnt;i++){
    const p=new THREE.Mesh(new THREE.SphereGeometry(.08+Math.random()*.13,4,4),new THREE.MeshBasicMaterial({color}));
    p.position.copy(pos); scene.add(p);
    particles.push({mesh:p,v:new THREE.Vector3((Math.random()-.5)*14,Math.random()*12,(Math.random()-.5)*14),life:.6+Math.random()*.4});
  }
}
function updateParticles(dt){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.v.y-=18*dt;
    p.mesh.position.addScaledVector(p.v,dt); p.life-=dt;
    p.mesh.material.opacity=p.life*2; p.mesh.material.transparent=true;
    if(p.life<=0){scene.remove(p.mesh);particles.splice(i,1);}
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WAVE SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function announce(txt,boss=false){
  const el=document.getElementById("wann"); el.textContent=txt; el.className=boss?"boss":"";
  el.style.opacity="1"; setTimeout(()=>el.style.opacity="0",2400);
}
function showMsg(txt){
  const el=document.getElementById("pmsg"); el.innerHTML=txt.replace("\n","<br>"); el.style.opacity="1";
  setTimeout(()=>el.style.opacity="0",2600);
}

function startWave(w){
  wave=w; waveComplete=false; enemiesThisWave=0; enemiesKilled=0;
  const dm=1+bossesDefeated*.3;
  const n=Math.floor((3+w*2)*dm);
  const delay=Math.max(240,650-bossesDefeated*40);
  announce("‚Äî OLA "+w+" ‚Äî");
  for(let i=0;i<n;i++) setTimeout(()=>spawnEnemy(),i*delay);
  const bd=n*delay+Math.max(3000,8000-bossesDefeated*500);
  setTimeout(()=>{
    const di=bossesDefeated%BOSS_DEFS.length;
    announce("‚ö† "+BOSS_DEFS[di].name+" SE ACERCA ‚ö†",true);
    setTimeout(()=>spawnBoss(),2000);
  },bd);
  updateHUD();
}
function checkWave(dt){
  if(!waveComplete&&enemies.length===0&&enemiesThisWave>0&&enemiesKilled>=enemiesThisWave){waveComplete=true;waveTimer=0;}
  if(waveComplete){
    waveTimer+=dt;
    if(waveTimer>4){
      waveComplete=false; waveTimer=0;
      players.forEach(p=>{ const wp=WEAPONS[p.weapon]; p.ammo=wp.ammo; p.reserve=Math.min(wp.reserve,p.reserve+wp.ammo*2); p.health=Math.min(100,p.health+20); });
      startWave(wave+1);
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateHUD(){
  players.forEach(p=>{
    document.getElementById("p"+p.id+"hp").style.width=p.health+"%";
    document.getElementById("p"+p.id+"ammo").textContent=p.reloading?"..":p.ammo;
    document.getElementById("p"+p.id+"res").textContent=p.reserve;
    document.getElementById("p"+p.id+"wep").textContent=WEAPONS[p.weapon].name;
  });
  document.getElementById("scoreval").textContent=score;
  document.getElementById("waveval").textContent=wave;
  // Crosshair modes
  const myP=netRole==="guest"?players[1]:players[0];
  document.getElementById("xhair-p1").className=myP.weapon==="dual"?"dual":"";
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAUSE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function togglePause(){
  gamePaused=!gamePaused; gameActive=!gamePaused;
  document.getElementById("pausescreen").style.display=gamePaused?"flex":"none";
  if(audioCtx&&bossGain) bossGain.gain.setTargetAtTime(gamePaused?0:.65,audioCtx.currentTime,.3);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEADERBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveScore(){
  const name=(document.getElementById("player-name").value.trim().toUpperCase()||"JUGADOR").slice(0,16);
  const entry={name,score,wave,date:new Date().toLocaleDateString("es-AR")};
  let scores=[];
  try{const r=await window.storage.get("void-scores",true); scores=JSON.parse(r.value);}catch(e){}
  scores.push(entry); scores.sort((a,b)=>b.score-a.score); scores=scores.slice(0,10);
  try{await window.storage.set("void-scores",JSON.stringify(scores),true);}catch(e){}
  renderLB(document.getElementById("deathlblist"),scores.slice(0,5),entry,true);
}
function renderLB(ul,list,you,death=false){
  ul.innerHTML="";
  const medals=["ü•á","ü•à","ü•â"];
  list.forEach((s,i)=>{
    const isYou=you&&s.name===you.name&&s.score===you.score&&s.wave===you.wave;
    const li=document.createElement("li");
    if(i===0)li.classList.add("g"); else if(i===1)li.classList.add("sv"); else if(i===2)li.classList.add("br");
    if(isYou)li.classList.add("you");
    const medal=i<3?medals[i]:("#"+(i+1));
    li.innerHTML="<span class=r>"+medal+"</span><span class=n>"+s.name+(isYou?" ‚óÄ":"")+"</span><span class=s>"+s.score.toLocaleString()+"</span><span class=w>OLA "+s.wave+"</span>";
    ul.appendChild(li);
  });
}
async function loadLB(){
  try{
    const r=await window.storage.get("void-scores",true);
    renderLB(document.getElementById("lb-list"),JSON.parse(r.value).slice(0,5),null);
  }catch(e){
    document.getElementById("lb-list").innerHTML="<li style='color:#334;font-size:.68rem;text-align:center;padding:8px;list-style:none'>Sin puntajes a√∫n</li>";
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// END / RESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function endGame(){
  gameActive=false; gamePaused=false; stopBossMusic();
  try{document.exitPointerLock();}catch(e){}
  document.getElementById("hud").style.display="none";
  document.getElementById("finalscore").textContent=score;
  document.getElementById("finalwave").textContent=wave;
  saveScore();
  document.getElementById("deathscreen").style.display="flex";
}

function resetGame(){
  enemies.forEach(en=>scene.remove(en.mesh)); eBullets.forEach(b=>scene.remove(b.mesh));
  bullets.forEach(b=>scene.remove(b.mesh)); particles.forEach(p=>scene.remove(p.mesh));
  guestMeshes.forEach(d=>scene.remove(d.mesh)); guestMeshes.clear();
  guestBullets.forEach(b=>scene.remove(b)); guestBullets.length=0;
  if(hostMesh){scene.remove(hostMesh);hostMesh=null;}
  enemies=[]; eBullets=[]; bullets=[]; particles=[];
  score=0; wave=1; currentTheme=0; bossesDefeated=0; enemyIdCtr=0; applyTheme(0);
  players.forEach(p=>{
    p.health=100; p.alive=true; p.ammo=WEAPONS.pistol.ammo; p.reserve=WEAPONS.pistol.reserve;
    p.weapon="pistol"; p.reloading=false; p.velY=0; p.onGround=true;
    p.recoil=0; p.bob=0; p.canShoot=true; p.shootCd=0; p.weaponUnlocked={pistol:true,dual:false};
  });
  players[0].cam.position.set(2,EYE_H,0); players[0].yaw=0; players[0].pitch=0;
  players[1].cam.position.set(-2,EYE_H,0); players[1].yaw=Math.PI; players[1].pitch=0;
  if(players[1].mesh){scene.remove(players[1].mesh);players[1].mesh=null;}
  bossAlive=false; bossRef=null; waveComplete=false; waveTimer=0;
  enemiesThisWave=0; enemiesKilled=0; gameActive=false; gamePaused=false; gameStarted=false;
  // Network cleanup
  if(peer){try{peer.destroy();}catch(e){}peer=null;}
  netConn=null; netRole=null;
  stopBossMusic();
  ["bossbar","pausescreen","deathscreen"].forEach(id=>document.getElementById(id).style.display="none");
  document.getElementById("hud").style.display="none";
  document.getElementById("overlay").style.display="flex";
  document.getElementById("p2hud").style.display="none";
  document.getElementById("xhair-p2").style.display="none";
  document.getElementById("netlbl").textContent="";
  document.getElementById("net-panel").classList.remove("show");
  netShowStep("net-step0"); netStatus("");
  menuMusic.currentTime=0;
  if(!musicMuted) menuMusic.play().catch(()=>{});
  loadLB();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START GAME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkName(){
  const v=document.getElementById("player-name").value.trim();
  if(!v){ showNameError(); return false; }
  return true;
}
function showNameError(){
  const el=document.getElementById("name-error"); el.textContent="‚ö† Ingresa tu nombre primero";
  const inp=document.getElementById("player-name"); inp.classList.add("shake");
  inp.focus(); setTimeout(()=>{inp.classList.remove("shake");el.textContent="";},2000);
}

function startOnlineGame(role){
  if(gameStarted) return;
  gameStarted=true; netRole=role;
  initAudio().catch(()=>{});
  menuMusic.pause(); menuMusic.currentTime=0;
  document.getElementById("overlay").style.display="none";
  document.getElementById("hud").style.display="block";
  document.getElementById("p2hud").style.display="flex";
  const name=document.getElementById("player-name").value.trim().toUpperCase()||"JUGADOR";
  if(role==="host"){
    document.getElementById("p1namelbl").textContent=name;
    document.getElementById("p2namelbl").textContent="J2 ONLINE";
    document.getElementById("netlbl").textContent="üü¢ ONLINE ‚Äî HOST";
    // P2 visible mesh for host to see guest
    players[1].mesh=buildPlayerMesh(0xffa040); scene.add(players[1].mesh);
    gameActive=true; updateHUD(); startWave(1);
    try{renderer.domElement.requestPointerLock();}catch(e){}
  } else {
    // Guest: control players[1] locally, render from players[1].cam
    document.getElementById("p1namelbl").textContent="HOST ONLINE";
    document.getElementById("p2namelbl").textContent=name;
    document.getElementById("netlbl").textContent="üü¢ ONLINE ‚Äî J2";
    // Host player visible mesh
    hostMesh=buildPlayerMesh(0x40aaff); scene.add(hostMesh);
    gameActive=true; updateHUD();
    try{renderer.domElement.requestPointerLock();}catch(e){}
  }
}

function startSoloGame(){
  if(!checkName()||gameStarted) return;
  gameStarted=true; netRole=null;
  initAudio().catch(()=>{});
  menuMusic.pause(); menuMusic.currentTime=0;
  const name=document.getElementById("player-name").value.trim().toUpperCase()||"JUGADOR";
  document.getElementById("p1namelbl").textContent=name;
  document.getElementById("overlay").style.display="none";
  document.getElementById("hud").style.display="block";
  gameActive=true; updateHUD(); startWave(1);
  try{renderer.domElement.requestPointerLock();}catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let last=0;
function loop(ts){
  requestAnimationFrame(loop);
  const dt=Math.min((ts-last)/1000,.05); last=ts;

  if(gameActive&&!gamePaused){
    if(netRole!=="guest"){
      // Host or solo: run full physics for both players if solo, or P1+receive P2
      resolvePhysics(players[0],dt);
      if(netRole==="host"&&players[1].mesh){
        players[1].mesh.position.copy(players[1].cam.position).setY(players[1].cam.position.y-EYE_H);
        players[1].mesh.rotation.y=players[1].yaw+Math.PI;
      }
      updateEnemies(dt); updateEBullets(dt); updateTracers(dt); updateParticles(dt); checkWave(dt);
      players[0].shootCd-=dt; if(players[0].shootCd<=0) players[0].canShoot=true;
      players[1].shootCd-=dt; if(players[1].shootCd<=0) players[1].canShoot=true;
    } else {
      // Guest: run own physics, send to host
      resolvePhysics(players[1],dt);
      players[1].shootCd-=dt; if(players[1].shootCd<=0) players[1].canShoot=true;
      updateTracers(dt); updateParticles(dt);
    }
  }

  // Networking sync
  if(gameStarted){
    netSendTimer+=dt;
    if(netSendTimer>=.05){ // 20fps
      netSendTimer=0;
      if(netRole==="host") sendHostState();
      else if(netRole==="guest") sendGuestInput();
    }
  }

  // Render: guest uses players[1].cam, everyone else uses players[0].cam
  const cam=netRole==="guest"?players[1].cam:players[0].cam;
  cam.aspect=innerWidth/innerHeight; cam.updateProjectionMatrix();
  renderer.setViewport(0,0,innerWidth,innerHeight);
  renderer.setScissor(0,0,innerWidth,innerHeight);
  renderer.render(scene,cam);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let musicMuted=false;
const menuMusic=document.getElementById("mus-menu"); menuMusic.volume=.5;
function tryPlayMusic(){
  const once=()=>{ if(!musicMuted&&!gameStarted)menuMusic.play().catch(()=>{});
    document.removeEventListener("click",once); document.removeEventListener("keydown",once); };
  document.addEventListener("click",once); document.addEventListener("keydown",once);
  menuMusic.play().catch(()=>{});
}
tryPlayMusic();
document.getElementById("btnMusic").addEventListener("click",()=>{
  musicMuted=!musicMuted;
  const btn=document.getElementById("btnMusic");
  if(musicMuted){menuMusic.pause();btn.textContent="üîá M√öSICA";btn.classList.add("muted");}
  else{menuMusic.play().catch(()=>{});btn.textContent="üîä M√öSICA";btn.classList.remove("muted");}
});

let audioCtx=null,audioBuffers={},bossSource=null,bossGain=null;
async function initAudio(){
  if(audioCtx) return;
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==="suspended") await audioCtx.resume();
  const files={player:"sonido-shooter-jugador.mp3",enemy:"shooter-enemigos.mp3",boss:"jefe-disparos.mp3",reload:"recargar-disparos.mp3"};
  await Promise.all(Object.entries(files).map(async([k,u])=>{
    try{const r=await fetch(u);const a=await r.arrayBuffer();audioBuffers[k]=await audioCtx.decodeAudioData(a);}
    catch(e){console.warn("Audio:",u);}
  }));
}
function playBuf(key,vol=1,loop2=false){
  if(!audioCtx||!audioBuffers[key]) return null;
  if(audioCtx.state==="suspended") audioCtx.resume();
  const src=audioCtx.createBufferSource(); src.buffer=audioBuffers[key]; src.loop=loop2;
  const g2=audioCtx.createGain(); g2.gain.value=vol;
  src.connect(g2); g2.connect(audioCtx.destination); src.start(0);
  return{src,gain:g2};
}
function startBossMusic(){stopBossMusic();const r=playBuf("boss",.65,true);if(r){bossSource=r.src;bossGain=r.gain;}}
function stopBossMusic(){if(bossSource){try{bossSource.stop();}catch(e){}bossSource=null;bossGain=null;}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT + EVENT HANDLERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
buildArena(); updateHUD(); loadLB(); requestAnimationFrame(loop);

// Solo start
document.getElementById("btnSolo").addEventListener("click",startSoloGame);
document.getElementById("player-name").addEventListener("keydown",e=>{ if(e.key==="Enter") startSoloGame(); });

// Online panel
document.getElementById("btnOnline").addEventListener("click",()=>{
  if(!checkName()) return;
  showNetPanel(); netShowStep("net-step0"); netStatus("Elige una opci√≥n");
});
document.getElementById("btnCreate").addEventListener("click",createRoom);
document.getElementById("btnJoinMode").addEventListener("click",()=>{ netShowStep("net-step-guest"); netStatus("Ingresa el c√≥digo de sala"); });
document.getElementById("btnJoin").addEventListener("click",joinRoom);
document.getElementById("room-code-input").addEventListener("keydown",e=>{ if(e.key==="Enter") joinRoom(); });
document.getElementById("btnCancelHost").addEventListener("click",cancelNet);
document.getElementById("btnCancelGuest").addEventListener("click",()=>{ cancelNet(); netShowStep("net-step0"); });

// Retry / Menu
document.getElementById("btnRetry").addEventListener("click",()=>{
  const wasOnline=!!netRole; const wasHost=netRole==="host";
  resetGame();
  setTimeout(()=>{ if(wasOnline){ showNetPanel(); if(wasHost) createRoom(); } else startSoloGame(); },150);
});
document.getElementById("btnMenu").addEventListener("click",resetGame);

// Pointer lock for mouse aim
document.addEventListener("pointerlockchange",()=>{
  if(!gameStarted&&!document.pointerLockElement){
    renderer.domElement.addEventListener("click",()=>{
      try{renderer.domElement.requestPointerLock();}catch(e){}
    },{once:true});
  }
});
</script>
</body>
</html>
