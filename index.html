<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>VOID HUNTER â€” 3D Shooter</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #000; overflow: hidden; font-family: 'Courier New', monospace; }
  #canvas { display: block; }

  #overlay {
    position: fixed; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    background: radial-gradient(ellipse at center, #0a0a1a 0%, #000 100%);
    z-index: 10;
  }
  #overlay h1 { font-size: 4rem; letter-spacing: 0.3em; color: #0ff; text-shadow: 0 0 20px #0ff, 0 0 60px #0af; animation: pulse 2s ease-in-out infinite; }
  #overlay p { color: #888; margin-top: 1rem; letter-spacing: 0.1em; font-size: 0.9rem; }
  #overlay .controls { color: #555; margin-top: 2rem; font-size: 0.75rem; line-height: 2; text-align: center; }
  #overlay .controls span { color: #0af; }
  #startBtn { margin-top: 2rem; padding: 0.8rem 3rem; background: transparent; border: 2px solid #0ff; color: #0ff; font-family: 'Courier New', monospace; font-size: 1rem; letter-spacing: 0.2em; cursor: pointer; transition: all 0.2s; text-transform: uppercase; }
  #startBtn:hover { background: #0ff2; box-shadow: 0 0 20px #0ff; }

  #hud { position: fixed; inset: 0; pointer-events: none; z-index: 5; display: none; }

  #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 24px; height: 24px; }
  #crosshair::before, #crosshair::after { content: ''; position: absolute; background: rgba(0,255,255,0.85); }
  #crosshair::before { width: 2px; height: 24px; left: 11px; top: 0; }
  #crosshair::after { width: 24px; height: 2px; left: 0; top: 11px; }
  #crosshair.dual::before { box-shadow: 8px 0 rgba(0,255,255,0.85), -8px 0 rgba(0,255,255,0.85); }

  #health-bar { position: absolute; bottom: 30px; left: 30px; display: flex; flex-direction: column; gap: 4px; }
  #health-label { color: #0af; font-size: 0.7rem; letter-spacing: 0.15em; }
  #health-track { width: 200px; height: 8px; background: #111; border: 1px solid #0af3; }
  #health-fill { height: 100%; background: linear-gradient(90deg, #0f8, #0af); width: 100%; transition: width 0.3s; }

  #ammo { position: absolute; bottom: 30px; right: 30px; color: #0af; font-size: 1.8rem; letter-spacing: 0.1em; text-align: right; }
  #ammo-label { font-size: 0.6rem; color: #555; letter-spacing: 0.2em; }

  #weapon-hud { position: absolute; bottom: 85px; right: 30px; text-align: right; }
  #weapon-name { font-size: 0.75rem; letter-spacing: 0.2em; color: #0ff; }
  #weapon-hint { font-size: 0.6rem; color: #ff0; letter-spacing: 0.1em; margin-top: 2px; display: none; }

  #reload-bar { position: absolute; bottom: 72px; right: 30px; width: 0; height: 3px; background: #0ff; transition: width 0s; }

  #score { position: absolute; top: 20px; right: 30px; color: #0ff; font-size: 1rem; letter-spacing: 0.2em; }
  #wave-info { position: absolute; top: 20px; left: 30px; color: #0af; font-size: 0.8rem; letter-spacing: 0.15em; }

  #boss-bar { position: absolute; top: 55px; left: 50%; transform: translateX(-50%); width: 420px; display: none; flex-direction: column; align-items: center; gap: 5px; }
  #boss-name { color: #f44; font-size: 0.85rem; letter-spacing: 0.2em; animation: bossGlow 0.8s infinite alternate; }
  #boss-track { width: 100%; height: 14px; background: #110000; border: 1px solid #f443; }
  #boss-fill { height: 100%; background: linear-gradient(90deg, #800, #f44); width: 100%; transition: width 0.15s; }

  #wave-announce { position: absolute; top: 33%; left: 50%; transform: translate(-50%,-50%); font-size: 2rem; letter-spacing: 0.3em; color: #0ff; text-shadow: 0 0 30px #0ff; opacity: 0; transition: opacity 0.4s; pointer-events: none; text-align: center; white-space: pre-line; }
  #wave-announce.boss { color: #f44; text-shadow: 0 0 30px #f44; }

  #pickup-msg { position: absolute; top: 42%; left: 50%; transform: translate(-50%,-50%); font-size: 1.1rem; letter-spacing: 0.15em; color: #ff0; text-shadow: 0 0 20px #ff0; opacity: 0; transition: opacity 0.3s; pointer-events: none; text-align: center; white-space: pre-line; line-height: 1.8; }

  #hit-flash { position: absolute; inset: 0; background: radial-gradient(ellipse at center, transparent 40%, #f005 100%); opacity: 0; pointer-events: none; transition: opacity 0.1s; }
  #kill-flash { position: absolute; inset: 0; background: rgba(0,255,200,0.08); opacity: 0; pointer-events: none; transition: opacity 0.3s; }

  #death-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 20; }
  #death-screen h2 { color: #f44; font-size: 3rem; letter-spacing: 0.3em; }
  #death-screen .stat { color: #888; margin-top: 0.6rem; letter-spacing: 0.1em; }
  #death-screen .stat span { color: #0ff; }
  #death-screen button { margin-top: 2rem; padding: 0.6rem 2rem; background: transparent; border: 2px solid #f44; color: #f44; font-family: 'Courier New', monospace; font-size: 0.9rem; letter-spacing: 0.2em; cursor: pointer; transition: all 0.2s; }
  #death-screen button:hover { background: #f442; }

  /* NAME INPUT */
  #name-row { display: flex; flex-direction: column; align-items: center; gap: 6px; margin-top: 1.5rem; }
  #name-label { color: #555; font-size: 0.7rem; letter-spacing: 0.2em; }
  #player-name {
    background: transparent; border: none; border-bottom: 2px solid #0af;
    color: #0ff; font-family: 'Courier New', monospace; font-size: 1.1rem;
    text-align: center; letter-spacing: 0.15em; width: 200px; outline: none;
    padding: 4px 0;
  }
  #player-name::placeholder { color: #334; }

  /* LEADERBOARD on overlay */
  #lb-overlay { margin-top: 1.5rem; width: 320px; }
  #lb-overlay-title { color: #0af; font-size: 0.65rem; letter-spacing: 0.25em; margin-bottom: 8px; text-align: center; }
  #lb-overlay-list { list-style: none; }
  #lb-overlay-list li { display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; font-size: 0.72rem; letter-spacing: 0.08em; border-bottom: 1px solid #0af1; }
  #lb-overlay-list li .rank { color: #555; width: 22px; }
  #lb-overlay-list li .lname { color: #0af; flex: 1; }
  #lb-overlay-list li .lscore { color: #0ff; }
  #lb-overlay-list li .lwave { color: #555; font-size: 0.62rem; margin-left: 8px; }
  #lb-overlay-list li.gold .rank, #lb-overlay-list li.gold .lname, #lb-overlay-list li.gold .lscore { color: #ffd700; }

  /* DEATH SCREEN LEADERBOARD */
  #death-lb { margin-top: 1.5rem; width: 380px; border: 1px solid #f443; padding: 12px 16px; }
  #death-lb-title { color: #f44; font-size: 0.65rem; letter-spacing: 0.25em; margin-bottom: 10px; text-align: center; }
  #death-lb-list { list-style: none; }
  #death-lb-list li { display: flex; justify-content: space-between; align-items: center; padding: 5px 4px; font-size: 0.75rem; letter-spacing: 0.08em; border-bottom: 1px solid #f441; }
  #death-lb-list li .rank { color: #555; width: 24px; }
  #death-lb-list li .lname { color: #ccc; flex: 1; }
  #death-lb-list li .lscore { color: #0ff; }
  #death-lb-list li .lwave { color: #555; font-size: 0.62rem; margin-left: 8px; }
  #death-lb-list li.you .lname, #death-lb-list li.you .lscore { color: #ff0; }
  #death-lb-list li.gold .rank { color: #ffd700; }
  #death-btns { display: flex; gap: 12px; }


  /* MUSIC & NAME VALIDATION */
  #name-error { color: #f44; font-size: 0.65rem; letter-spacing: 0.15em; margin-top: 4px; height: 14px; }
  #player-name.error { border-bottom-color: #f44; animation: shake 0.3s; }
  #music-btn {
    margin-top: 0.6rem; padding: 0.4rem 1.2rem;
    background: transparent; border: 1px solid #0af4;
    color: #0af; font-family: 'Courier New', monospace;
    font-size: 0.7rem; letter-spacing: 0.15em;
    cursor: pointer; transition: all 0.2s;
  }
  #music-btn:hover { background: #0af1; border-color: #0af; }
  #music-btn.muted { color: #444; border-color: #2224; }
  @keyframes shake {
    0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)}
  }
  @keyframes pulse { 0%,100% { text-shadow: 0 0 20px #0ff, 0 0 60px #0af; } 50% { text-shadow: 0 0 40px #0ff, 0 0 100px #0af, 0 0 5px #fff; } }
  @keyframes bossGlow { from { text-shadow: 0 0 8px #f44; } to { text-shadow: 0 0 25px #f44, 0 0 4px #fff; } }
</style>
</head>
<body>

<div id="overlay">
  <h1>VOID HUNTER</h1>
  <p>SHOOTER 3D â€” SURVIVAL MODE</p>
  <div class="controls">
    <span>WASD</span> â€” Mover &nbsp;&nbsp; <span>MOUSE</span> â€” Apuntar<br>
    <span>CLICK</span> â€” Disparar &nbsp;&nbsp; <span>R</span> â€” Recargar<br>
    <span>Q / RUEDA</span> â€” Cambiar arma &nbsp;&nbsp; <span>SHIFT</span> â€” Correr
  </div>
  <div id="name-row">
    <div id="name-label">INGRESA TU NOMBRE</div>
    <input id="player-name" type="text" maxlength="16" placeholder="JUGADOR" autocomplete="off" spellcheck="false">
    <div id="name-error"></div>
  </div>
  <button id="startBtn">[ INICIAR ]</button>
  <button id="music-btn">ðŸ”Š MÃšSICA: ON</button>
  <audio id="menu-music"  src="menu-disparos.mp3"          loop preload="auto"></audio>
  <audio id="snd-player" src="sonido-shooter-jugador.mp3"       preload="auto"></audio>
  <audio id="snd-enemy"  src="shooter-enemigos.mp3"             preload="auto"></audio>
  <audio id="snd-boss"   src="jefe-disparos.mp3"           loop preload="auto"></audio>
  <audio id="snd-reload" src="recargar-disparos.mp3"            preload="auto"></audio>
  <div id="lb-overlay">
    <div id="lb-overlay-title">â€” MEJORES PUNTAJES â€”</div>
    <ul id="lb-overlay-list"><li style="color:#333;font-size:0.7rem;text-align:center;padding:8px">Cargando...</li></ul>
  </div>
</div>

<div id="hud">
  <div id="crosshair"></div>
  <div id="health-bar">
    <div id="health-label">SALUD</div>
    <div id="health-track"><div id="health-fill"></div></div>
  </div>
  <div id="weapon-hud">
    <div id="weapon-name">PISTOLA</div>
    <div id="weapon-hint">[ Q ] DOBLE PISTOLA DISPONIBLE</div>
  </div>
  <div id="reload-bar"></div>
  <div id="ammo">
    <div id="ammo-label">MUNICIÃ“N</div>
    <span id="ammo-current">30</span><span style="color:#444"> / </span><span id="ammo-reserve">150</span>
  </div>
  <div id="score">SCORE: <span id="score-val">0</span></div>
  <div id="wave-info">OLA: <span id="wave-val">1</span></div>
  <div id="boss-bar">
    <div id="boss-name">âš  JEFE âš </div>
    <div id="boss-track"><div id="boss-fill"></div></div>
  </div>
  <div id="wave-announce"></div>
  <div id="pickup-msg"></div>
  <div id="hit-flash"></div>
  <div id="kill-flash"></div>
</div>

<div id="death-screen">
  <h2>ELIMINADO</h2>
  <div class="stat">SCORE FINAL: <span id="final-score">0</span></div>
  <div class="stat">OLA ALCANZADA: <span id="final-wave">0</span></div>
  <div id="death-lb">
    <div id="death-lb-title">â€” TABLA DE PUNTUACIONES â€”</div>
    <ul id="death-lb-list"></ul>
  </div>
  <div id="death-btns">
    <button onclick="location.reload()">[ REINTENTAR ]</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// â”€â”€â”€ SCENE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x000008, 0.035);
scene.background = new THREE.Color(0x000008);
const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 200);
camera.position.set(0, 1.7, 0);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);
renderer.domElement.id = 'canvas';
window.addEventListener('resize', () => {
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

// â”€â”€â”€ LIGHTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
scene.add(new THREE.AmbientLight(0x001133, 0.5));
for(let i=0; i<6; i++){
  const pl = new THREE.PointLight(0x0044ff, 0.8, 20);
  const a = (i/6)*Math.PI*2;
  pl.position.set(Math.cos(a)*25, 0.5, Math.sin(a)*25);
  scene.add(pl);
}

// â”€â”€â”€ ARENA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const obstacles = [];
function buildArena() {
  const floor = new THREE.Mesh(new THREE.PlaneGeometry(100,100), new THREE.MeshStandardMaterial({ color:0x000511, roughness:0.9 }));
  floor.rotation.x = -Math.PI/2; scene.add(floor);
  scene.add(new THREE.GridHelper(100, 50, 0x001a44, 0x000a22));
  const wm = new THREE.MeshStandardMaterial({ color: 0x000a1a });
  [[0,5,-50,[0,0,0]],[0,5,50,[0,Math.PI,0]],[-50,5,0,[0,Math.PI/2,0]],[50,5,0,[0,-Math.PI/2,0]]].forEach(([x,y,z,r]) => {
    const w = new THREE.Mesh(new THREE.PlaneGeometry(100,10), wm);
    w.position.set(x,y,z); w.rotation.set(...r); scene.add(w);
  });
  const pm = new THREE.MeshStandardMaterial({ color:0x0a1525, roughness:0.7, metalness:0.3 });
  [[10,10],[-10,10],[10,-10],[-10,-10],[20,0],[-20,0],[0,20],[0,-20],[15,-15],[-15,15]].forEach(([x,z]) => {
    const p = new THREE.Mesh(new THREE.BoxGeometry(2,4,2), pm);
    p.position.set(x,2,z); p.castShadow=true; scene.add(p);
    obstacles.push({x,z,r:1.5});
  });
}

// â”€â”€â”€ WEAPONS CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WEAPONS = {
  pistol: { name:'PISTOLA',       ammo:30,  reserve:150, damage:30, cooldown:0.14, shots:1, spread:0   },
  dual:   { name:'DOBLE PISTOLA', ammo:60,  reserve:240, damage:26, cooldown:0.09, shots:2, spread:0.05 },
};
let currentWeapon = 'pistol';
const weaponUnlocked = { pistol:true, dual:false };

// â”€â”€â”€ GAME STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let health=100, score=0, wave=1;
let ammo=30, ammoReserve=150, reloading=false;
let enemies=[], bullets=[], particles=[], enemyBullets=[];
let gameActive=false, waveTimer=0;
let enemiesThisWave=0, enemiesKilled=0;
let bossAlive=false, bossRef=null, waveComplete=false;

// â”€â”€â”€ CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const keys={};
let pitch=0, yawAngle=0, canShoot=true, shootCooldown=0;
document.addEventListener('keydown', e=>{ keys[e.code]=true; });
document.addEventListener('keyup',   e=>{ keys[e.code]=false; });
document.addEventListener('keydown', e=>{
  if(e.code==='KeyR' && !reloading && ammoReserve>0 && ammo<WEAPONS[currentWeapon].ammo) doReload();
  if(e.code==='KeyQ') cycleWeapon();
});
document.addEventListener('wheel', e=>{ if(gameActive) cycleWeapon(); });
document.addEventListener('click', ()=>{ if(gameActive) shoot(); });

function cycleWeapon() {
  const avail = Object.keys(weaponUnlocked).filter(k=>weaponUnlocked[k]);
  if(avail.length < 2) return;
  const i = avail.indexOf(currentWeapon);
  currentWeapon = avail[(i+1) % avail.length];
  const wp = WEAPONS[currentWeapon];
  ammo = wp.ammo; ammoReserve = wp.reserve; reloading = false;
  showMsg('[ ' + wp.name + ' ]');
  updateHUD();
}

// â”€â”€â”€ SHOOTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shoot() {
  if(!canShoot || reloading || ammo<=0) {
    if(ammo<=0 && ammoReserve>0) doReload();
    return;
  }
  const wp = WEAPONS[currentWeapon];
  ammo = Math.max(0, ammo - wp.shots);
  updateHUD();

  // Muzzle flash
  const fl = document.getElementById('kill-flash');
  fl.style.background='rgba(255,200,50,0.15)'; fl.style.opacity='1';
  setTimeout(()=>{ fl.style.opacity='0'; fl.style.background='rgba(0,255,200,0.08)'; },55);

  playPlayerShot();

  for(let s=0; s<wp.shots; s++) {
    // Offset direction for dual shots
    const offsetX = wp.shots>1 ? (s===0 ? -wp.spread : wp.spread) : 0;
    const dir = new THREE.Vector3(offsetX, 0, -1).normalize();
    dir.applyEuler(new THREE.Euler(pitch, yawAngle, 0, 'YXZ'));
    dir.x += (Math.random()-.5)*0.008;
    dir.y += (Math.random()-.5)*0.008;
    dir.normalize();

    // Hit detection
    let hit=null, minDist=Infinity;
    enemies.forEach(en=>{
      const center = en.mesh.position.clone();
      center.y = en.isBoss ? 2.0 : 1.0;
      const toEn = center.clone().sub(camera.position);
      const d = toEn.length();
      const dot = dir.dot(toEn.normalize());
      const perp = Math.sqrt(Math.max(0, 1-dot*dot)) * d;
      const hr = en.isBoss ? 2.0 : 1.0;
      if(dot>0.1 && perp<hr && d<minDist) { minDist=d; hit=en; }
    });

    if(hit) {
      const dmg = wp.damage + Math.random()*8;
      hit.hp -= dmg;
      spawnHitParticles(hit.mesh.position.clone().setY(hit.isBoss?2:1));
      if(hit.hp<=0) killEnemy(hit);
      else if(hit.isBoss) updateBossBar(hit);
    }
    spawnTracer(camera.position.clone(), dir);
  }

  canShoot=false; shootCooldown=wp.cooldown;
}

function doReload() {
  if(reloading || ammoReserve<=0) return;
  reloading=true;
  playBuffer('reload', 0.7);
  const bar = document.getElementById('reload-bar');
  bar.style.transition='width 0s'; bar.style.width='0';
  setTimeout(()=>{ bar.style.transition='width 1.4s linear'; bar.style.width='130px'; },10);
  setTimeout(()=>{
    const wp=WEAPONS[currentWeapon];
    const need=wp.ammo-ammo, take=Math.min(need,ammoReserve);
    ammo+=take; ammoReserve-=take; reloading=false;
    bar.style.transition='width 0s'; bar.style.width='0';
    updateHUD();
  },1500);
}

// â”€â”€â”€ ENEMIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ECOLORS=[0xff2222,0xff6600,0xaa00ff,0xff0099,0x00ffcc];
function spawnEnemy() {
  const a=Math.random()*Math.PI*2, d=28+Math.random()*15;
  const x=Math.cos(a)*d, z=Math.sin(a)*d;
  const col=ECOLORS[wave%ECOLORS.length];
  const g=new THREE.Group();
  const bm=new THREE.MeshStandardMaterial({color:col,emissive:col,emissiveIntensity:0.3});
  const body=new THREE.Mesh(new THREE.BoxGeometry(0.8,1.2,0.8),bm);
  body.position.y=0.6; g.add(body);
  const head=new THREE.Mesh(new THREE.SphereGeometry(0.35,8,8),new THREE.MeshStandardMaterial({color:col,emissive:col,emissiveIntensity:0.5}));
  head.position.y=1.55; g.add(head);
  const el=new THREE.PointLight(col,1,3); el.position.set(0,1.55,0.4); g.add(el);
  g.position.set(x,0,z); scene.add(g);
  const hp=75+wave*25;
  enemies.push({mesh:g,hp,maxHp:hp,speed:1.5+wave*0.25,shootTimer:1+Math.random()*2,isBoss:false});
  enemiesThisWave++;
}

function spawnBoss() {
  const a=Math.random()*Math.PI*2;
  const x=Math.cos(a)*38, z=Math.sin(a)*38;
  const bossHp = 300 + wave*200;
  const g=new THREE.Group();

  // Main body â€” big and menacing
  const body=new THREE.Mesh(new THREE.BoxGeometry(2.4,2.8,2.4),
    new THREE.MeshStandardMaterial({color:0x220000,emissive:0xff0000,emissiveIntensity:0.35,metalness:0.6}));
  body.position.y=1.4; g.add(body);

  // Shoulders
  [-1.5,1.5].forEach(sx=>{
    const sh=new THREE.Mesh(new THREE.SphereGeometry(0.7,8,8),
      new THREE.MeshStandardMaterial({color:0x440000,emissive:0xff2200,emissiveIntensity:0.5}));
    sh.position.set(sx,2.5,0); g.add(sh);
  });

  // Head (boxy)
  const head=new THREE.Mesh(new THREE.BoxGeometry(1.4,1.3,1.4),
    new THREE.MeshStandardMaterial({color:0x300000,emissive:0xff0000,emissiveIntensity:0.6}));
  head.position.y=3.7; g.add(head);

  // Eye glow
  [[-0.35,0.1],[0.35,0.1]].forEach(([ex])=>{
    const eye=new THREE.Mesh(new THREE.SphereGeometry(0.13,6,6),new THREE.MeshBasicMaterial({color:0xffff00}));
    eye.position.set(ex,3.8,0.7); g.add(eye);
  });

  // Horns
  [-0.4,0.4].forEach(hx=>{
    const horn=new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.2,0.8,6),new THREE.MeshStandardMaterial({color:0x880000}));
    horn.position.set(hx,4.4,0); horn.rotation.z=hx>0?-0.3:0.3; g.add(horn);
  });

  const light=new THREE.PointLight(0xff0000,3,10); light.position.set(0,2,0); g.add(light);
  g.position.set(x,0,z); scene.add(g);

  const boss={mesh:g,hp:bossHp,maxHp:bossHp,speed:1.6+wave*0.25,shootTimer:0.7,isBoss:true};
  enemies.push(boss); bossRef=boss; bossAlive=true; enemiesThisWave++;

  document.getElementById('boss-bar').style.display='flex';
  document.getElementById('boss-name').textContent=`âš   JEFE  â€”  OLA ${wave}  âš `;
  updateBossBar(boss);
  startBossMusic();
}

function updateBossBar(b) {
  document.getElementById('boss-fill').style.width=(Math.max(0,b.hp/b.maxHp*100))+'%';
}

function killEnemy(en) {
  const wasBoss=en.isBoss;
  const col=wasBoss?0xff4400:ECOLORS[wave%ECOLORS.length];
  spawnExplosion(en.mesh.position.clone(), col, wasBoss?50:18);
  scene.remove(en.mesh);
  enemies.splice(enemies.indexOf(en),1);
  score+=wasBoss?500*wave:100*wave;
  enemiesKilled++;

  if(wasBoss) {
    bossAlive=false; bossRef=null;
    stopBossMusic();
    document.getElementById('boss-bar').style.display='none';
    if(!weaponUnlocked.dual) {
      weaponUnlocked.dual=true;
      document.getElementById('weapon-hint').style.display='block';
      showMsg('ðŸ”«  DOBLE PISTOLA DESBLOQUEADA\n[ Q ] para equipar');
    } else {
      showMsg('ðŸ‘‘  JEFE ELIMINADO\n+' + (500*wave) + ' pts');
    }
    health=Math.min(100, health+35);
  }
  const kf=document.getElementById('kill-flash');
  kf.style.opacity='1'; setTimeout(()=>kf.style.opacity='0',200);
  updateHUD();
}

// â”€â”€â”€ ENEMY AI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateEnemies(dt) {
  const pp=camera.position;
  enemies.forEach(en=>{
    const dx=pp.x-en.mesh.position.x, dz=pp.z-en.mesh.position.z;
    const dist=Math.sqrt(dx*dx+dz*dz);
    const nx=dx/dist, nz=dz/dist;
    en.mesh.position.x+=nx*en.speed*dt;
    en.mesh.position.z+=nz*en.speed*dt;
    en.mesh.position.y=en.isBoss?Math.sin(Date.now()*0.0015)*0.15:Math.sin(Date.now()*0.005+en.mesh.position.x)*0.05;
    en.mesh.lookAt(pp.clone().setY(en.isBoss?2:0.8));
    en.shootTimer-=dt;
    if(en.shootTimer<=0) {
      const mR=en.isBoss?4:2.5;
      if(dist<mR) {
        takeDamage(en.isBoss?10+wave*3:12);
      } else if(dist<45) {
        const sc=en.isBoss?3:1;
        for(let s=0;s<sc;s++) {
          const sp=en.isBoss?(s-1)*0.13:0;
          spawnEBullet(en.mesh.position.clone(), nx+sp, nz, en.isBoss);
        }
      }
      en.shootTimer=en.isBoss?0.8+Math.random()*0.4:1.5+Math.random();
    }
  });
}

// â”€â”€â”€ ENEMY BULLETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnEBullet(pos, dx, dz, isBoss=false) {
  playEnemyShot();
  const b=new THREE.Mesh(
    new THREE.SphereGeometry(isBoss?0.18:0.1,6,6),
    new THREE.MeshBasicMaterial({color:isBoss?0xff8800:0xff4400})
  );
  pos.y=1.2; b.position.copy(pos);
  const sp=isBoss?11:8;
  scene.add(b);
  const len=Math.sqrt(dx*dx+dz*dz)||1;
  enemyBullets.push({mesh:b,vx:(dx/len)*sp,vz:(dz/len)*sp,life:5,dmg:isBoss?14:8});
}

function updateEBullets(dt) {
  for(let i=enemyBullets.length-1;i>=0;i--) {
    const b=enemyBullets[i];
    b.mesh.position.x+=b.vx*dt; b.mesh.position.z+=b.vz*dt; b.life-=dt;
    const dx=b.mesh.position.x-camera.position.x, dz=b.mesh.position.z-camera.position.z;
    if(Math.sqrt(dx*dx+dz*dz)<0.6) {
      takeDamage(b.dmg); scene.remove(b.mesh); enemyBullets.splice(i,1);
    } else if(b.life<=0) { scene.remove(b.mesh); enemyBullets.splice(i,1); }
  }
}

function takeDamage(amt) {
  health=Math.max(0,health-amt);
  const hf=document.getElementById('hit-flash');
  hf.style.opacity='1'; setTimeout(()=>hf.style.opacity='0',140);
  updateHUD();
  if(health<=0) endGame();
}

// â”€â”€â”€ TRACERS & PARTICLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnTracer(from, dir) {
  const g=new THREE.CylinderGeometry(0.012,0.012,3,4); g.rotateX(Math.PI/2);
  const m=new THREE.Mesh(g,new THREE.MeshBasicMaterial({color:0xffee88,transparent:true,opacity:0.8}));
  m.position.copy(from.clone().add(dir.clone().multiplyScalar(1.5)));
  m.lookAt(from.clone().add(dir)); scene.add(m);
  bullets.push({mesh:m,life:0.07});
}
function updateTracers(dt) {
  for(let i=bullets.length-1;i>=0;i--) {
    bullets[i].life-=dt;
    if(bullets[i].life<=0){scene.remove(bullets[i].mesh);bullets.splice(i,1);}
  }
}
function spawnHitParticles(pos) {
  for(let i=0;i<8;i++) {
    const p=new THREE.Mesh(new THREE.SphereGeometry(0.05,4,4),new THREE.MeshBasicMaterial({color:0xff4444}));
    p.position.copy(pos); scene.add(p);
    particles.push({mesh:p,v:new THREE.Vector3((Math.random()-.5)*5,Math.random()*5,(Math.random()-.5)*5),life:0.4});
  }
}
function spawnExplosion(pos, color, count=20) {
  for(let i=0;i<count;i++) {
    const p=new THREE.Mesh(new THREE.SphereGeometry(0.08+Math.random()*0.14,4,4),new THREE.MeshBasicMaterial({color}));
    p.position.copy(pos); scene.add(p);
    particles.push({mesh:p,v:new THREE.Vector3((Math.random()-.5)*13,Math.random()*11,(Math.random()-.5)*13),life:0.6+Math.random()*0.5});
  }
}
function updateParticles(dt) {
  for(let i=particles.length-1;i>=0;i--) {
    const p=particles[i];
    p.v.y-=15*dt; p.mesh.position.addScaledVector(p.v,dt);
    p.life-=dt; p.mesh.material.opacity=p.life*2; p.mesh.material.transparent=true;
    if(p.life<=0){scene.remove(p.mesh);particles.splice(i,1);}
  }
}

// â”€â”€â”€ PLAYER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const vel=new THREE.Vector3();
function updatePlayer(dt) {
  const spd=keys['ShiftLeft']?9:5;
  const fwd=new THREE.Vector3(-Math.sin(yawAngle),0,-Math.cos(yawAngle));
  const rgt=new THREE.Vector3(Math.cos(yawAngle),0,-Math.sin(yawAngle));
  vel.set(0,0,0);
  if(keys['KeyW']) vel.addScaledVector(fwd,spd);
  if(keys['KeyS']) vel.addScaledVector(fwd,-spd);
  if(keys['KeyA']) vel.addScaledVector(rgt,-spd);
  if(keys['KeyD']) vel.addScaledVector(rgt,spd);
  const np=camera.position.clone().addScaledVector(vel,dt);
  np.x=Math.max(-48,Math.min(48,np.x)); np.z=Math.max(-48,Math.min(48,np.z));
  let blocked=false;
  obstacles.forEach(ob=>{ const dx=np.x-ob.x,dz=np.z-ob.z; if(Math.sqrt(dx*dx+dz*dz)<ob.r+0.5) blocked=true; });
  if(!blocked){camera.position.x=np.x;camera.position.z=np.z;}
  camera.position.y=1.7; camera.rotation.order='YXZ';
  camera.rotation.y=yawAngle; camera.rotation.x=pitch;
  if(!canShoot){shootCooldown-=dt;if(shootCooldown<=0)canShoot=true;}
}

// â”€â”€â”€ WAVE SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function announce(txt, isBoss=false) {
  const el=document.getElementById('wave-announce');
  el.textContent=txt; el.className=isBoss?'boss':'';
  el.style.opacity='1'; setTimeout(()=>el.style.opacity='0',2500);
}

function startWave(w) {
  wave=w; waveComplete=false; enemiesThisWave=0; enemiesKilled=0;
  const n=3+w*2;
  announce(`â€” OLA ${w} â€”`);
  for(let i=0;i<n;i++) setTimeout(()=>spawnEnemy(), i*650);
  // Boss after all normal enemies
  setTimeout(()=>{
    announce(`âš  JEFE ENTRANDO âš `, true);
    setTimeout(()=>spawnBoss(), 1600);
  }, n*650+1000);
  updateHUD();
}

function checkWave(dt) {
  if(!waveComplete && enemies.length===0 && enemiesThisWave>0 && enemiesKilled>=enemiesThisWave) {
    waveComplete=true; waveTimer=0;
  }
  if(waveComplete) {
    waveTimer+=dt;
    if(waveTimer>4) {
      waveComplete=false; waveTimer=0;
      const wp=WEAPONS[currentWeapon];
      ammo=wp.ammo; ammoReserve=Math.min(wp.reserve, ammoReserve+wp.ammo*2);
      health=Math.min(100, health+20);
      startWave(wave+1);
    }
  }
}

// â”€â”€â”€ HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMsg(txt) {
  const el=document.getElementById('pickup-msg');
  el.innerHTML=txt.replace('\n','<br>'); el.style.opacity='1';
  setTimeout(()=>el.style.opacity='0',2800);
}
function updateHUD() {
  document.getElementById('health-fill').style.width=health+'%';
  document.getElementById('ammo-current').textContent=reloading?'...':ammo;
  document.getElementById('ammo-reserve').textContent=ammoReserve;
  document.getElementById('score-val').textContent=score;
  document.getElementById('wave-val').textContent=wave;
  document.getElementById('weapon-name').textContent=WEAPONS[currentWeapon].name;
  document.getElementById('crosshair').className=currentWeapon==='dual'?'dual':'';
}
function endGame() {
  gameActive=false; document.exitPointerLock();
  document.getElementById('hud').style.display='none';
  document.getElementById('final-score').textContent=score;
  document.getElementById('final-wave').textContent=wave;
  saveScoreAndShow();
}

async function saveScoreAndShow() {
  const name = (document.getElementById('player-name').value.trim().toUpperCase() || 'JUGADOR').slice(0,16);
  const entry = { name, score, wave, date: new Date().toLocaleDateString('es-AR') };

  // Load existing scores
  let scores = [];
  try {
    const res = await window.storage.get('void-hunter-scores', true);
    scores = JSON.parse(res.value);
  } catch(e) { scores = []; }

  // Add new score and keep top 10
  scores.push(entry);
  scores.sort((a,b) => b.score - a.score);
  scores = scores.slice(0, 10);

  try { await window.storage.set('void-hunter-scores', JSON.stringify(scores), true); } catch(e) {}

  renderDeathLeaderboard(scores, entry);
  document.getElementById('death-screen').style.display='flex';
}

function renderDeathLeaderboard(scores, currentEntry) {
  const ul = document.getElementById('death-lb-list');
  ul.innerHTML = '';
  const medals = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
  scores.forEach((s, i) => {
    const isYou = s.name===currentEntry.name && s.score===currentEntry.score && s.wave===currentEntry.wave;
    const li = document.createElement('li');
    if(i===0) li.classList.add('gold');
    if(isYou) li.classList.add('you');
    const medal = medals[i] || ('#'+(i+1));
    const arrow = isYou ? ' â—€' : '';
    li.innerHTML = '<span class="rank">'+medal+'</span><span class="lname">'+s.name+arrow+'</span><span class="lscore">'+s.score.toLocaleString()+'</span><span class="lwave">OLA '+s.wave+'</span>';
    ul.appendChild(li);
  });
}

async function loadOverlayLeaderboard() {
  try {
    const res = await window.storage.get('void-hunter-scores', true);
    const scores = JSON.parse(res.value);
    const ul = document.getElementById('lb-overlay-list');
    ul.innerHTML='';
    const medals=['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
    scores.forEach((s,i)=>{
      const li=document.createElement('li');
      if(i===0) li.classList.add('gold');
      const medal2 = medals[i] || ('#'+(i+1));
      li.innerHTML = '<span class="rank">'+medal2+'</span><span class="lname">'+s.name+'</span><span class="lscore">'+s.score.toLocaleString()+'</span><span class="lwave">OLA '+s.wave+'</span>';
      ul.appendChild(li);
    });
  } catch(e) {
    document.getElementById('lb-overlay-list').innerHTML='<li style="color:#334;font-size:0.7rem;text-align:center;padding:8px;list-style:none">Sin puntajes aÃºn</li>';
  }
}

// â”€â”€â”€ GAME LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let last=0;
function loop(ts) {
  requestAnimationFrame(loop);
  const dt=Math.min((ts-last)/1000,0.05); last=ts;
  if(gameActive) {
    updatePlayer(dt); updateEnemies(dt);
    updateEBullets(dt); updateTracers(dt);
    updateParticles(dt); checkWave(dt);
  }
  renderer.render(scene,camera);
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buildArena();
updateHUD();
requestAnimationFrame(loop);

loadOverlayLeaderboard();

// â”€â”€â”€ MENU MUSIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let musicMuted = false;
const menuMusic = document.getElementById('menu-music');
menuMusic.volume = 0.5;

// Try autoplay; if blocked, wait for first user interaction
function tryPlayMusic() {
  menuMusic.play().catch(() => {
    const playOnce = () => {
      if(!musicMuted && !gameStarted) menuMusic.play().catch(()=>{});
      document.removeEventListener('click', playOnce);
      document.removeEventListener('keydown', playOnce);
    };
    document.addEventListener('click', playOnce);
    document.addEventListener('keydown', playOnce);
  });
}
tryPlayMusic();

document.getElementById('music-btn').addEventListener('click', () => {
  musicMuted = !musicMuted;
  const btn = document.getElementById('music-btn');
  if(musicMuted) {
    menuMusic.pause();
    btn.textContent = 'ðŸ”‡ MÃšSICA: OFF';
    btn.classList.add('muted');
  } else {
    menuMusic.play().catch(()=>{});
    btn.textContent = 'ðŸ”Š MÃšSICA: ON';
    btn.classList.remove('muted');
  }
});

// â”€â”€â”€ SOUND FX (AudioContext) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let audioCtx = null;
const audioBuffers = {};
let bossSource = null;
let bossGain = null;

async function initAudio() {
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  // Resume if suspended (needed on some browsers)
  if(audioCtx.state === 'suspended') await audioCtx.resume();

  const files = {
    player: 'sonido-shooter-jugador.mp3',
    enemy:  'shooter-enemigos.mp3',
    boss:   'jefe-disparos.mp3',
    reload: 'recargar-disparos.mp3'
  };
  await Promise.all(Object.entries(files).map(async ([key, url]) => {
    try {
      const res = await fetch(url);
      const arr = await res.arrayBuffer();
      audioBuffers[key] = await audioCtx.decodeAudioData(arr);
    } catch(e) { console.warn('No se pudo cargar:', url, e); }
  }));
}

function playBuffer(key, volume=1.0, loop=false) {
  if(!audioCtx || !audioBuffers[key]) return null;
  if(audioCtx.state === 'suspended') audioCtx.resume();
  const src = audioCtx.createBufferSource();
  src.buffer = audioBuffers[key];
  src.loop = loop;
  const gain = audioCtx.createGain();
  gain.gain.value = volume;
  src.connect(gain);
  gain.connect(audioCtx.destination);
  src.start(0);
  return { src, gain };
}

function playPlayerShot() { playBuffer('player', 0.6); }
function playEnemyShot()  { playBuffer('enemy',  0.3); }

function startBossMusic() {
  stopBossMusic();
  const result = playBuffer('boss', 0.65, true);
  if(result) { bossSource = result.src; bossGain = result.gain; }
}
function stopBossMusic() {
  if(bossSource) {
    try { bossSource.stop(); } catch(e){}
    bossSource = null; bossGain = null;
  }
}

let gameStarted = false;
function startGame() {
  if(gameStarted) return;
  const nameInput = document.getElementById('player-name');
  const nameVal = nameInput.value.trim();
  const errEl = document.getElementById('name-error');
  if(!nameVal) {
    errEl.textContent = 'âš  DEBES INGRESAR TU NOMBRE ANTES DE JUGAR';
    nameInput.classList.add('error');
    nameInput.focus();
    setTimeout(()=>{ nameInput.classList.remove('error'); errEl.textContent=''; }, 2000);
    return;
  }
  gameStarted = true;
  // Init audio on user gesture (required by browsers)
  initAudio().catch(()=>{});
  // Stop menu music
  const music = document.getElementById('menu-music');
  music.pause(); music.currentTime = 0;
  document.getElementById('overlay').style.display='none';
  document.getElementById('hud').style.display='block';
  gameActive = true;
  updateHUD();
  startWave(1);
  try { renderer.domElement.requestPointerLock(); } catch(e){}
}

document.getElementById('player-name').addEventListener('keydown', e=>{
  if(e.key==='Enter') startGame();
});
document.getElementById('startBtn').addEventListener('click', ()=> startGame());

// Mouse look: works with or without pointer lock
document.addEventListener('mousemove', e=>{
  if(!gameActive) return;
  const dx = e.movementX || e.mozMovementX || 0;
  const dy = e.movementY || e.mozMovementY || 0;
  yawAngle -= dx * 0.002;
  pitch = Math.max(-1.2, Math.min(1.2, pitch - dy * 0.002));
});

document.addEventListener('pointerlockchange',()=>{
  if(!gameStarted) return;
  if(!document.pointerLockElement) {
    // Pointer lock lost but game keeps going; re-request on next click
    renderer.domElement.addEventListener('click', ()=>{
      try { renderer.domElement.requestPointerLock(); } catch(e){}
    }, {once:true});
  }
});
</script>
</body>
</html>
